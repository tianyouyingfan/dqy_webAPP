<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <title>D&DÊàòÊñóÂä©Êâã</title>
    <link rel="stylesheet" href="style.css">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
     <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0F1012">
    <script src="vendor/vue.global.prod.min.js"></script>
    <script src="vendor/dexie.min.js"></script>
</head>
<body>
    <div id="app" class="app" v-cloak>
        <header>
            <div class="topbar">
                <div class="brand">
                    <div class="dot"></div>
                    <div>D&DËæÖÂä©Â∑•ÂÖ∑</div>
                </div>
                <nav class="tabs">
                    <div class="tab" :class="{active: route==='monsters'}" @click="route='monsters'">ÊÄ™Áâ©Â∫ì</div>
                    <div class="tab" :class="{active: route==='pcs'}" @click="route='pcs'">PCËßíËâ≤Â∫ì</div>
                    <div class="tab" :class="{active: route==='actions'}" @click="route='actions'">Âä®‰ΩúÂ∫ì</div>
                    <div class="tab" :class="{active: route==='battle'}" @click="route='battle'">ÊàòÊñó</div>
                    <div class="tab" :class="{active: route==='settings'}" @click="route='settings'">ÂØºÂÖ•/ÂØºÂá∫</div>
                </nav>
                <div class="spacer"></div>
                <button class="btn" @click="toggleTheme">ÂàáÊç¢‰∏ªÈ¢ò</button>
            </div>
        </header>

        <main>
            <!-- ÊÄ™Áâ©Â∫ìÂàóË°®È°µ -->
            <section v-if="route==='monsters'">
                <div class="toolbar">
                    <input class="input" style="min-width:240px" v-model="monsterFilters.keyword" placeholder="ÊåâÂêçÁß∞ÊêúÁ¥¢..." />
                    <select v-model="monsterFilters.cr" class="input">
                        <option value="">CRÔºàÂÖ®ÈÉ®Ôºâ</option>
                        <option v-for="cr in crOptions" :key="cr" :value="cr">{{cr}}</option>
                    </select>
                    <div class="row">
                        <span class="muted small">Á±ªÂûãÁ≠õÈÄâÔºö</span>
                        <span v-for="t in monsterTypes" :key="t" class="chip" :class="{active: monsterFilters.types.includes(t)}" @click="toggleTypeFilter(t)">{{ translateType(t) }}</span>
                    </div>
                    <div class="spacer"></div>
                    <button class="btn" @click="openMonsterEditor()">+ Êñ∞Âª∫ÊÄ™Áâ©</button>
                    <button class="btn" @click="openAbilityPool()">ËÉΩÂäõÊ±†</button>
                    <button class="btn" @click="seedDemo">ËΩΩÂÖ•ÊºîÁ§∫Êï∞ÊçÆ</button>
                    <button class="btn" @click="openGroupManager()">ËÆæÁΩÆÁªÑÂêàÂá∫Êàò</button>
                </div>

                <div class="grid cards">
                    <div class="card" v-for="m in filteredMonsters" :key="m.id">
                        <div class="row">
                            <div class="avatar">
                                <img v-if="m.avatar" :src="m.avatar" alt="Avatar">
                                <span v-else>üßü</span>
                            </div>
                            <div class="title">{{m.name}}</div>
                            <span class="pill right mono">CR {{m.cr}}</span>
                        </div>
                        <div class="kpi muted small" style="margin-top:6px">
                            <span class="pill">AC {{m.ac}}</span>
                            <span class="pill">HP {{m.hp?.average ?? m.hp ?? '‚Äî'}}</span>
                            <span class="pill">{{(m.type||[]).map(translateType).join(', ') || 'Êú™ÂàÜÁ±ª'}}</span>
                            <span class="pill" v-if="m.isCustom">Ëá™ÂÆö‰πâ</span>
                        </div>
                        <div class="hl"></div>
                        <div class="row">
                            <button class="btn" @click="openMonsterEditor(m)">ËØ¶ÊÉÖ/‰º™ÁºñËæë</button>
                            <button class="btn" @click="addToBattleFromMonster(m)">Âä†ÂÖ•ÊàòÊñó</button>
                            <div class="spacer"></div>
                            <button class="btn" @click="duplicateMonster(m)">Â§çÂà∂</button>
                            <button class="btn danger" @click="deleteMonster(m.id)">Âà†Èô§</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- PC ËßíËâ≤Â∫ì -->
            <section v-if="route==='pcs'">
                <div class="toolbar">
                    <button class="btn" @click="openPCEditor()">+ Êñ∞Âª∫PC</button>
                </div>
                <div class="grid cards">
                    <div class="card" v-for="pc in pcs" :key="pc.id">
                        <div class="row">
                            <div class="avatar">
                                <img v-if="pc.avatar" :src="pc.avatar" alt="Avatar">
                                <span v-else>üßù</span>
                            </div>
                            <div class="title">{{pc.name}}</div>
                            <span class="pill right">AC {{pc.ac}}</span>
                        </div>
                        <div class="kpi muted small" style="margin-top:6px">
                            <span class="pill">HP {{pc.hpCurrent}}/{{pc.hpMax}}</span>
                            <span class="pill">Êïè {{mod(pc.abilities.dex)}} Âäõ {{mod(pc.abilities.str)}} ‰Ωì {{mod(pc.abilities.con)}}</span>
                        </div>
                        <div class="hl"></div>
                        <div class="row">
                            <button class="btn" @click="openPCEditor(pc)">ÁºñËæë</button>
                            <button class="btn" @click="addToBattleFromPC(pc)">Âä†ÂÖ•ÊàòÊñó</button>
                            <div class="spacer"></div>
                            <button class="btn danger" @click="deletePC(pc.id)">Âà†Èô§</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Âä®‰ΩúÂ∫ì -->
            <section v-if="route==='actions'">
                <div class="toolbar">
                    <button class="btn" @click="openActionEditor()">+ Êñ∞Âª∫Âä®‰Ωú</button>
                </div>
                <div class="grid cards">
                    <div class="card" v-for="action in actions" :key="action.id">
                        <div class="row">
                            <div class="title">{{action.name}}</div>
                            <span class="pill right">{{action.type}}</span>
                        </div>
                        <div class="kpi muted small" style="margin-top:6px">
                            <span class="pill" v-if="action.attackBonus">ÊîªÂáª+{{action.attackBonus}}</span>
                            <span class="pill" v-if="action.range">Ë∑ùÁ¶ª: {{action.range}}</span>
                            <span class="pill" v-if="action.damages?.length">{{ formatDamages(action.damages) }}</span>
                            <span class="pill" v-if="action.saveDC">Ë±ÅÂÖç DC{{action.saveDC}} {{action.saveAbility}}</span>
                        </div>
                        <div class="hl"></div>
                        <div class="row">
                            <button class="btn" @click="openActionEditor(action)">ÁºñËæë</button>
                            <div class="spacer"></div>
                            <button class="btn danger" @click="deleteAction(action.id)">Âà†Èô§</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ÊàòÊñó‰∏ªÁïåÈù¢Ôºà‰∏âÂå∫Â∏ÉÂ±ÄÔºâ -->
            <section v-if="route==='battle'">
                <div class="battle">
                    <!-- È°∂ÈÉ®ÂÖàÊîªÂ∫èÂàóÊù°Ôºà20%Ôºâ -->
                    <div class="initiative-bar hscroll" @dragover.prevent>
                        <div v-for="(p, idx) in battle.participants" :key="p.uid"
                             class="init-tile"
                             :class="{'active-turn-highlight': currentActor && p.uid === currentActor.uid}"
                             :ref="(el) => { if (el) participantTiles.set(p.uid, el); }"
                             draggable="true" @dragstart="onDragStart(idx)" @drop="onDrop(idx)">
                            <div class="init-header">
                                <div class="drag-handle" title="ÊãñÊãΩË∞ÉÊï¥È°∫Â∫è">‚†ø</div>
                                <div class="avatar">
                                    <img v-if="p.avatar" :src="p.avatar" alt="Avatar">
                                    <span v-else>üéØ</span>
                                </div>
                                <div class="col">
                                    <div style="font-weight:700">{{p.name}}</div>
                                    <div class="small muted">ÂÖàÊîª {{p.initiativeRoll ?? '‚Äî'}} + {{p.initiativeModifier ?? '‚Äî'}}</div>
                                </div>
                                <div class="spacer"></div>
                                <div class="hp">{{p.hpCurrent}}/{{p.hpMax}}</div>
                            </div>
                            <div class="statuses">
<span v-for="s in p.statuses" :key="s.id" class="status" :data-tooltip="s.name + ' Ââ©‰Ωô'+ s.rounds +'ÂõûÂêà'">
                                    {{s.icon || '‚è≥'}} {{s.name}} ({{s.rounds}})
                                </span>
                            </div>
                            <div class="row">
                                <button class="btn small" @click="setCurrentActor(p.uid)">ËÆæ‰∏∫ÂΩìÂâç</button>
                                <button class="btn small" @click="removeParticipant(p.uid)">ÁßªÈô§</button>
                            </div>
                        </div>
                    </div>

                    <!-- ‰∏ãÊñπÂ∑¶Âè≥‰∏§‰æßÔºàÂêÑ50%Ôºâ -->
                    <div class="battle-grid">
                        <!-- Â∑¶ÔºöÂΩìÂâçË°åÂä®ËÄÖËØ¶ÊÉÖ -->
                        <div class="pane">
                            <div class="sticky-toolbar row">
                                <button class="btn" @click="promptAddParticipants()">+ Ê∑ªÂä†Âçï‰Ωç</button>
                                <button class="btn" @click="rollInitiative()">Êé∑ÂÖàÊîª</button>
                                <button class="btn" @click="prevTurn()">‰∏ä‰∏Ä‰∏™</button>
                                <button class="btn primary" @click="nextTurn()">‰∏ã‰∏Ä‰∏™</button>
                                <button class="btn warn" @click="resetBattle()">ÂàùÂßãÂåñÊàòÊñó</button>
                                <span class="pill right">ÂõûÂêàÔºö{{battle.round}}</span>
                            </div>
                            <template v-if="currentActor">
                                <div class="actor-header">
                                    <div class="avatar" style="width:40px;height:40px;font-size:20px; cursor: pointer;" @click="openActorViewer(currentActor)">
                                        <img v-if="currentActor.avatar" :src="currentActor.avatar" alt="Avatar">
                                        <span v-else>üéØ</span>
                                    </div>
                                    <div class="col">
                                        <div class="title" style="cursor: pointer;" @click="openActorViewer(currentActor)">{{currentActor.name}}</div>
                                        <div class="muted small">AC {{currentActor.ac}} ¬∑ HP {{currentActor.hpCurrent}}/{{currentActor.hpMax}}</div>
                                    </div>
                                    <div class="spacer"></div>
                                    <div class="row">
                                        <input class="input small mono" style="width:120px" v-model.number="hpDelta" placeholder="+/-HP">
                                        <button class="btn small" @click="applyHPDelta(currentActor, hpDelta)">Â∫îÁî®</button>
                                        <button class="btn small" @click="applyHPDelta(currentActor, Math.floor(hpDelta/2))">Âçä‰º§</button>
                                        <button class="btn small" @click="applyHPDelta(currentActor, hpDelta*2)">ÂèåÂÄç</button>
                                        <button class="btn small ok" @click="applyHPDelta(currentActor, Math.abs(hpDelta))">Ê≤ªÁñó</button>
                                    </div>
                                </div>

                                <div class="hl"></div>
                                <div class="section-title">ÂÖ≠Â§ßÂ±ûÊÄß</div>
                                <div class="ability-grid">
                                    <div class="ability" v-for="(v,k) in currentActor.abilities" :key="k">
                                        <div class="muted small">{{k.toUpperCase()}}</div>
                                        <div style="font-weight:700">{{v}} ({{mod(v)>=0?'+':''}}{{mod(v)}})</div>
                                    </div>
                                </div>

                                <div class="hl"></div>
                                <div class="section-title">Âä®‰Ωú/ËÉΩÂäõ</div>
                                <div class="actions-list">
                                    <button class="btn" v-for="a in currentActor.actions || []" :key="a.id" @click="selectAction(a)" :disabled="a.cooldown > 0">
                                        {{a.name}}
                                        <span v-if="a.cooldown > 0" class="muted small">(ÂÜ∑Âç¥‰∏≠ {{a.cooldown}})</span>
                                        <span v-else class="muted small">({{a.type}})</span>
                                    </button>
                                    <span class="muted small" v-if="!currentActor.actions?.length">ÊöÇÊó†Âä®‰ΩúÔºàTODOÔºöÂú®ÊÄ™Áâ©/PCÁºñËæëÂ§ÑÊ∑ªÂä†Âä®‰ΩúÔºâ</span>
                                </div>

                                <template v-if="ui.selectedAction">
                                    <div class="hl"></div>
                                    <div class="row">
                                        <div class="section-title">Ëá™Âä®ÂåñÊîªÂáªÊµÅÁ®ã</div>
                                        <span class="pill">Ê®°Âºè</span>
                                        <select class="input" v-model="ui.rollMode">
                                            <option value="normal">Êó†</option>
                                            <option value="adv">‰ºòÂäø</option>
                                            <option value="dis">Âä£Âäø</option>
                                        </select>
                                        <span class="pill">Ëá™Âä®Êâ£Ë°Ä</span>
                                        <input type="checkbox" v-model="ui.autoApplyDamage">
                                        <div class="spacer"></div>
                                        <button class="btn" @click="runAction()" :disabled="ui.actionOnCooldown">
                                            {{ ui.actionOnCooldown ? 'ÊâßË°å‰∏≠...' : `ÊâßË°å ${ui.selectedAction.name}` }}
                                        </button>
                                        <button class="btn ghost" @click="ui.selectedAction=null">ÂèñÊ∂à</button>
                                    </div>
                                    <div class="row small muted">ÊèêÁ§∫ÔºöÂú®Âè≥‰æßÊàòÂú∫ÊÄªËßàÈù¢Êùø‰∏≠Â§öÈÄâÁõÆÊ†á</div>
                                    <div class="hl"></div>
                                    <div class="log" style="min-height:100px">{{ui.log || 'ÊàòÊñóÊó•ÂøóÂ∞ÜÊòæÁ§∫‰∫éÊ≠§'}}</div>
                                </template>

                                <div class="hl"></div>
                                <div class="section-title">Áä∂ÊÄÅÁÆ°ÁêÜ</div>
                                <div class="row">
                                    <button class="btn" @click="openStatusPicker(currentActor)">+ ÊñΩÂä†Áä∂ÊÄÅ</button>
                                    <div class="spacer"></div>
                                    <span class="muted small">Áä∂ÊÄÅÂà∞ÊúüÂêéÂ∞ÜËá™Âä®ÁßªÈô§ÔºàÂõûÂêàÂºÄÂßãÊó∂ÁªìÁÆóÔºâ</span>
                                </div>
                                <div class="row" style="margin-top:8px;flex-wrap:wrap;gap:8px">
                                    <span v-for="s in currentActor.statuses" :key="s.id" class="status">
                                        {{s.icon || '‚è≥'}} {{s.name}} ({{s.rounds}})
                                        <button class="btn small ghost" @click="removeStatus(currentActor, s.id)">ÁßªÈô§</button>
                                    </span>
                                </div>
                            </template>
                            <div v-else class="placeholder">ËØ∑ÈÄâÊã©ÊàñÊ∑ªÂä†Ë°åÂä®ËÄÖ</div>
                        </div>

                        <!-- Âè≥ÔºöÊàòÂú∫ÊÄªËßà -->
                        <div class="pane">
                            <div class="row">
                                <div class="section-title">ÊàòÂú∫ÊÄªËßà ¬∑ ÁõÆÊ†áÈÄâÊã©Âô®</div>
                                <div class="spacer"></div>
                                <button class="btn" @click="selectNone()">Ê∏ÖÈô§ÈÄâÊã©</button>
                            </div>
                            <div class="hl"></div>
                            <div v-for="g in groupedParticipants" :key="g.groupName" style="margin-bottom: 12px;">
                                <div class="row">
                                    <div class="title">{{g.groupName}}</div>
                                    <div class="spacer"></div>
                                    <button class="btn small" @click="toggleSelectGroup(g)">ÈÄâÊã©ÁªÑ</button>
                                </div>
                                <div class="hl"></div>
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    <div v-for="p in g.members" :key="p.uid" 
                                        class="target-card" 
                                        :class="{selected: ui.selectedTargets.includes(p.uid)}" 
                                        @click="toggleTarget(p.uid)">
                                        <div class="row" style="width: 100%; align-items: center;">
                                            <div class="avatar" @click.stop="openQuickDamageEditor(p)" style="cursor: pointer;">
                                                <img v-if="p.avatar" :src="p.avatar" alt="Avatar">
                                                <span v-else>üéØ</span>
                                            </div>
                                            <div style="font-weight:700" @click.stop="openQuickDamageEditor(p)" style="cursor: pointer;">{{p.name}}</div>
                                            <div class="spacer"></div>
                                            <div class="hp">{{p.hpCurrent}}/{{p.hpMax}}</div>
                                            <div class="small muted" style="min-width: 50px; margin-left: 8px;">AC {{p.ac}}</div>
                                            <span class="pill">ÂÖàÊîª {{p.initiative ?? '‚Äî'}}</span>
                                            <button class="btn small" @click.stop="openHPEditor(p)">HP</button>
                                            <button class="btn small" @click.stop="openStatusPicker(p)">+ Áä∂ÊÄÅ</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="hl"></div>
                            <div class="danger-zone small">
                                TODOÔºöÊàòÂú∫Êï¥‰ΩìÊ†áËÆ∞/ÊâãÂä®ÂàÜÁªÑ‰∏éÈáçÂëΩÂêçÁÆ°ÁêÜ‰∫§‰∫íÂ¢ûÂº∫ÔºàÁõÆÂâçÊåâÊÄ™Áâ©/PCËá™Âä®ÊàêÁªÑÔºåÂèØÂú®Âçï‰ΩçËØ¶ÊÉÖÈáçÂëΩÂêçÂàÜÁªÑÔºâ
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ÂØºÂÖ•/ÂØºÂá∫ -->
            <section v-if="route==='settings'">
                <div class="card">
                    <div class="section-title">Êï∞ÊçÆÂØºÂÖ•/ÂØºÂá∫ÔºàJSONÔºåÂÖ®ÈáèÔºâ</div>
                    <div class="row">
                        <button class="btn" @click="exportAll()">ÂØºÂá∫ÂÖ®ÈÉ®Êï∞ÊçÆ</button>
                        <input type="file" ref="file" accept="application/json" @change="importAll" hidden>
                        <button class="btn" @click="$refs.file.click()">ÂØºÂÖ•Êï∞ÊçÆ</button>
                        <div class="spacer"></div>
                        <span class="muted">ÊâÄÊúâÊï∞ÊçÆÂùáÂ≠òÂÇ®‰∫éÊµèËßàÂô® IndexedDBÔºåÊîØÊåÅÁ¶ªÁ∫ø‰ΩøÁî®</span>
                    </div>
                </div>
                <div class="hl"></div>
                <div class="card">
                    <div class="section-title">È°πÁõÆËØ¥Êòé/Âç†‰Ωç</div>
                    <div class="placeholder">
                        - TODOÔºöÂÆåÊï¥ÁöÑ„ÄäÊÄ™Áâ©ÂõæÈâ¥„ÄãÊ†∑ÂºèÊéíÁâàÔºàÊåâÂÆòÊñπÈ£éÊ†ºÔºâ<br>
                        - TODOÔºöCR ‰∏ÄÈîÆË∞ÉÊï¥ÁÆóÊ≥ïÁªÜËäÇÂÆåÂñÑ‰∏é‚Äú‰º§ÂÆ≥/ËΩÆ‚ÄùÂèçÁÆó‰º§ÂÆ≥È™∞<br>
                        - TODOÔºöÊõ¥‰∏∞ÂØåÁöÑÁä∂ÊÄÅÂõæÊ†á‰∏éËØ¥Êòé„ÄÅÊÇ¨ÊµÆÊèêÁ§∫<br>
                    </div>
                </div>
            </section>
        </main>

        <!-- Ê®°ÊÄÅÔºöÁîüÁâ©ËØ¶ÊÉÖÊü•ÁúãÂô® -->
        <div class="modal-mask" v-if="ui.actorViewer.open">
            <div class="modal" v-if="ui.actorViewer.actor">
                <div class="row">
                    <div class="title">ÁîüÁâ©ËØ¶ÊÉÖ</div>
                    <div class="spacer"></div>
                    <button class="btn" @click="ui.actorViewer.open=false">ÂÖ≥Èó≠</button>
                </div>
                <div class="hl"></div>

                <!-- PC Êü•ÁúãÊ®°Âºè -->
                <template v-if="ui.actorViewer.actor.type === 'pc'">
                    <div class="row">
                        <div class="avatar" style="width: 60px; height: 60px; font-size: 30px;">
                            <img v-if="ui.actorViewer.actor.avatar" :src="ui.actorViewer.actor.avatar" alt="Avatar" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
                            <span v-else>üßù</span>
                        </div>
                        <div class="col">
                            <h2 style="margin: 0;">{{ ui.actorViewer.actor.name }}</h2>
                            <div class="kpi muted small" style="margin-top: 8px;">
                                <span class="pill">AC {{ui.actorViewer.actor.ac}}</span>
                                <span class="pill">HP {{ui.actorViewer.actor.hpCurrent}} / {{ui.actorViewer.actor.hpMax}}</span>
                            </div>
                        </div>
                    </div>
                    <div class="hl"></div>
                    <div class="section-title">ÂÖ≠Â§ßÂ±ûÊÄß</div>
                    <div class="ability-grid">
                        <div class="ability" v-for="(v,k) in ui.actorViewer.actor.abilities" :key="k">
                            <div class="muted small">{{k.toUpperCase()}}</div>
                            <div style="font-weight:700">{{v}} ({{mod(v)>=0?'+':''}}{{mod(v)}})</div>
                        </div>
                    </div>
                    <div class="hl"></div>
                    <div class="three-col">
                        <div class="col">
                            <div class="section-title">‰º§ÂÆ≥ÊäóÊÄß</div>
                            <div class="muted small">{{ (ui.actorViewer.actor.resistances.damage || []).join(', ') || 'Êó†' }}</div>
                        </div>
                        <div class="col">
                            <div class="section-title">‰º§ÂÆ≥Êòì‰º§</div>
                            <div class="muted small">{{ (ui.actorViewer.actor.vulnerabilities.damage || []).join(', ') || 'Êó†' }}</div>
                        </div>
                        <div class="col">
                            <div class="section-title">‰º§ÂÆ≥ÂÖçÁñ´</div>
                            <div class="muted small">{{ (ui.actorViewer.actor.immunities.damage || []).join(', ') || 'Êó†' }}</div>
                        </div>
                        <div class="col">
                            <div class="section-title">Áä∂ÊÄÅÂÖçÁñ´</div>
                            <div class="muted small">{{ (ui.actorViewer.actor.immunities.conditions || []).join(', ') || 'Êó†' }}</div>
                        </div>
                    </div>
                    <div class="hl"></div>
                    <div class="section-title">ÁâπÊÄß</div>
                    <div class="muted small" style="white-space: pre-wrap; background: #1a1d21; padding: 8px; border-radius: 8px;">{{ ui.actorViewer.actor.features || 'Êó†' }}</div>
                    <div class="hl"></div>
                    <div class="section-title">Âä®‰Ωú</div>
                    <div class="grid" style="gap: 8px;">
                        <div class="card" v-for="a in ui.actorViewer.actor.actions" :key="a.id">
                            <div class="row">
                                <div class="title">{{ a.name }}</div>
                                <div class="spacer"></div>
                                <span class="tag">{{ a.type }}</span>
                            </div>
                            <div class="muted small" style="margin-top: 6px;">
                                <template v-if="a.type === 'attack'">
                                    <span>ÊîªÂáª+{{ a.attackBonus }}</span>,
                                    <span v-if="a.range">Ë∑ùÁ¶ª: {{ a.range }}</span>,
                                    <span>‰º§ÂÆ≥: {{ formatDamages(a.damages) }}</span>
                                </template>
                                <template v-else-if="a.type === 'save'">
                                    <span>Ë±ÅÂÖçDC {{ a.saveDC }} {{ a.saveAbility?.toUpperCase() }}</span>,
                                    <span>‰º§ÂÆ≥: {{ formatDamages(a.damages) }}</span>
                                </template>
                                <template v-else>
                                    <span>{{ a.note || 'ÂÆûÁî®ËÉΩÂäõ' }}</span>
                                </template>
                            </div>
                        </div>
                        <div v-if="!ui.actorViewer.actor.actions?.length" class="placeholder small">Êó†Âä®‰Ωú</div>
                    </div>
                </template>

                <!-- Monster Êü•ÁúãÊ®°Âºè -->
                <template v-else>
                    <div class="monster-view-container" style="position: relative;">
                        <img v-if="ui.actorViewer.actor.backgroundImage" :src="ui.actorViewer.actor.backgroundImage" style="position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; opacity: 0.3; z-index: 1; border-radius: var(--radius);">
                        <div style="position: relative; z-index: 2; padding: 12px;">
                            <div class="row">
                                <h2 style="margin: 0;">{{ ui.actorViewer.actor.name }}</h2>
                                <div class="spacer"></div>
                                <span class="pill mono">CR {{ui.actorViewer.actor.cr}}</span>
                            </div>
                            <div class="kpi muted small" style="margin-top: 8px;">
                                <span class="pill">AC {{ui.actorViewer.actor.ac}}</span>
                                <span class="pill">HP {{ui.actorViewer.actor.hpCurrent}} / {{ui.actorViewer.actor.hpMax}}</span>
                                <span class="pill">ÈÄüÂ∫¶ {{(ui.actorViewer.actor.speed && ui.actorViewer.actor.speed.walk) || '?'}}ft</span>
                                <span class="pill">{{ (ui.actorViewer.actor.monsterType||[]).map(translateType).join(', ') || 'Êú™ÂàÜÁ±ª' }}</span>
                            </div>
                            <div class="hl"></div>
                            <div class="section-title">ÂÖ≠Â§ßÂ±ûÊÄß</div>
                            <div class="ability-grid">
                                <div class="ability" v-for="(v,k) in ui.actorViewer.actor.abilities" :key="k">
                                    <div class="muted small">{{k.toUpperCase()}}</div>
                                    <div style="font-weight:700">{{v}} ({{mod(v)>=0?'+':''}}{{mod(v)}})</div>
                                </div>
                            </div>
                            <div class="hl"></div>
                            <div class="three-col">
                                <div class="col">
                                    <div class="section-title">‰º§ÂÆ≥ÊäóÊÄß</div>
                                    <div class="muted small">{{ ui.actorViewer.actor.resistances.damage.join(', ') || 'Êó†' }}</div>
                                </div>
                                <div class="col">
                                    <div class="section-title">‰º§ÂÆ≥Êòì‰º§</div>
                                    <div class="muted small">{{ ui.actorViewer.actor.vulnerabilities.damage.join(', ') || 'Êó†' }}</div>
                                </div>
                                <div class="col">
                                    <div class="section-title">‰º§ÂÆ≥ÂÖçÁñ´</div>
                                    <div class="muted small">{{ ui.actorViewer.actor.immunities.damage.join(', ') || 'Êó†' }}</div>
                                </div>
                                <div class="col">
                                    <div class="section-title">Áä∂ÊÄÅÂÖçÁñ´</div>
                                    <div class="muted small">{{ ui.actorViewer.actor.immunities.conditions.join(', ') || 'Êó†' }}</div>
                                </div>
                            </div>
                            <div class="hl"></div>
                            <div class="section-title">ÁâπÊÆäËÉΩÂäõ/Âä®‰Ωú</div>
                            <div class="grid" style="gap: 8px;">
                                <div class="card" v-for="a in ui.actorViewer.actor.actions" :key="a.id">
                                    <div class="row">
                                        <div class="title">{{ a.name }}</div>
                                        <div class="spacer"></div>
                                        <span class="tag">{{ a.type }}</span>
                                        <span class="tag" v-if="a.recharge > 0">ÂÖÖËÉΩ {{ a.recharge }}</span>
                                    </div>
                                    <div class="muted small" style="margin-top: 6px;">
                                        <template v-if="a.type === 'attack'">
                                            <span>ÊîªÂáª+{{ a.attackBonus }}</span>,
                                            <span v-if="a.range">Ë∑ùÁ¶ª: {{ a.range }}</span>,
                                            <span>‰º§ÂÆ≥: {{ formatDamages(a.damages) }}</span>
                                        </template>
                                        <template v-else-if="a.type === 'save'">
                                            <span>Ë±ÅÂÖçDC {{ a.saveDC }} {{ a.saveAbility?.toUpperCase() }}</span>,
                                            <span>‰º§ÂÆ≥: {{ formatDamages(a.damages) }}</span>,
                                            <span v-if="a.onSuccess === 'half'">ÊàêÂäüÂàôÂçä‰º§</span>
                                        </template>
                                        <template v-else>
                                            <span>{{ a.note || 'ÂÆûÁî®ËÉΩÂäõ' }}</span>
                                        </template>
                                    </div>
                                </div>
                                <div v-if="!ui.actorViewer.actor.actions?.length" class="placeholder small">Êó†ÁâπÊÆäËÉΩÂäõÊàñÂä®‰Ωú</div>
                            </div>
                        </div>
                    </div>
                </template>

                <div class="hl"></div>
                <div class="row">
                    <div class="spacer"></div>
                    <button class="btn" @click="ui.actorViewer.open=false">ÂÖ≥Èó≠</button>
                </div>
            </div>
        </div>

        <!-- Ê®°ÊÄÅÔºöÊÄ™Áâ©ÁºñËæëÂô® -->
        <div class="modal-mask" v-if="ui.monsterEditor.open">
            <div class="modal">
                <div class="row">
                    <div class="title">ÊÄ™Áâ©ËØ¶ÊÉÖ/ÁºñËæëÂô®</div>
                    <div class="spacer"></div>
                    <button class="btn" @click="ui.monsterEditor.mode = ui.monsterEditor.mode === 'view' ? 'edit' : 'view'">
                        {{ ui.monsterEditor.mode === 'view' ? 'ÂàáÊç¢Âà∞ÁºñËæëÊ®°Âºè' : 'ÂàáÊç¢Âà∞Êü•ÁúãÊ®°Âºè' }}
                    </button>
                    <button class="btn" @click="ui.monsterEditor.open=false">ÂÖ≥Èó≠</button>
                </div>
                <div class="hl"></div>

                <!-- Êü•ÁúãÊ®°Âºè -->
                <div v-if="ui.monsterEditor.mode === 'view'">
                    <div class="monster-view-container" style="position: relative;">
                        <!-- ËÉåÊôØÂõæ -->
                        <img v-if="uiState.monsterDraft.backgroundImage" :src="uiState.monsterDraft.backgroundImage" style="position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; opacity: 0.3; z-index: 1; border-radius: var(--radius);">
                        
                        <!-- ÂÜÖÂÆπÂÆπÂô® -->
                        <div style="position: relative; z-index: 2; padding: 12px;">
                            <div class="row">
                                <!-- ‰∏ä‰º†ÊåâÈíÆ -->
                                <input type="file" ref="bgUpload" @change="onBgImageSelect" accept="image/*" hidden>
                                <button class="btn" @click="$refs.bgUpload.click()">‰∏ä‰º†ËÉåÊôØ</button>
                                <h2 style="margin: 0;">{{ uiState.monsterDraft.name }}</h2>
                                <div class="spacer"></div>
                                <span class="pill mono">CR {{uiState.monsterDraft.cr}}</span>
                            </div>
                            <div class="kpi muted small" style="margin-top: 8px;">
                                <span class="pill">AC {{uiState.monsterDraft.ac}}</span>
                                <span class="pill">HP {{uiState.monsterDraft.hp.average}}</span>
                                <span class="pill">ÈÄüÂ∫¶ {{uiState.monsterDraft.speed.walk}}ft</span>
                                <span class="pill">{{ (uiState.monsterDraft.type||[]).map(translateType).join(', ') || 'Êú™ÂàÜÁ±ª' }}</span>
                            </div>

                            <div class="hl"></div>
                            
                            <div class="section-title">ÂÖ≠Â§ßÂ±ûÊÄß</div>
                            <div class="ability-grid">
                                <div class="ability" v-for="(v,k) in uiState.monsterDraft.abilities" :key="k">
                                    <div class="muted small">{{k.toUpperCase()}}</div>
                                    <div style="font-weight:700">{{v}} ({{mod(v)>=0?'+':''}}{{mod(v)}})</div>
                                </div>
                            </div>

                            <div class="hl"></div>

                            <div class="three-col">
                                <div class="col">
                                    <div class="section-title">‰º§ÂÆ≥ÊäóÊÄß</div>
                                    <div class="muted small">{{ uiState.monsterDraft.resistances.damage.join(', ') || 'Êó†' }}</div>
                                </div>
                                <div class="col">
                                    <div class="section-title">‰º§ÂÆ≥Êòì‰º§</div>
                                    <div class="muted small">{{ uiState.monsterDraft.vulnerabilities.damage.join(', ') || 'Êó†' }}</div>
                                </div>
                                <div class="col">
                                    <div class="section-title">‰º§ÂÆ≥ÂÖçÁñ´</div>
                                    <div class="muted small">{{ uiState.monsterDraft.immunities.damage.join(', ') || 'Êó†' }}</div>
                                </div>
                                <div class="col">
                                    <div class="section-title">Áä∂ÊÄÅÂÖçÁñ´</div>
                                    <div class="muted small">{{ uiState.monsterDraft.immunities.conditions.join(', ') || 'Êó†' }}</div>
                                </div>
                            </div>

                            <div class="hl"></div>

                            <div class="section-title">ÁâπÊÆäËÉΩÂäõ/Âä®‰Ωú</div>
                            <div class="grid" style="gap: 8px;">
                                <div class="card" v-for="a in uiState.monsterDraft.actions" :key="a.id">
                                    <div class="row">
                                        <div class="title">{{ a.name }}</div>
                                        <div class="spacer"></div>
                                        <span class="tag">{{ a.type }}</span>
                                        <span class="tag" v-if="a.recharge > 0">ÂÖÖËÉΩ {{ a.recharge }}</span>
                                    </div>
                                    <div class="muted small" style="margin-top: 6px;">
                <template v-if="a.type === 'attack'">
                    <span>ÊîªÂáª+{{ a.attackBonus }}</span>,
                    <span v-if="a.range">Ë∑ùÁ¶ª: {{ a.range }}</span>,
                    <span>‰º§ÂÆ≥: {{ formatDamages(a.damages) }}</span>
                </template>
                                        <template v-else-if="a.type === 'save'">
                                            <span>Ë±ÅÂÖçDC {{ a.saveDC }} {{ a.saveAbility?.toUpperCase() }}</span>,
                                            <span>‰º§ÂÆ≥: {{ formatDamages(a.damages) }}</span>,
                                            <span v-if="a.onSuccess === 'half'">ÊàêÂäüÂàôÂçä‰º§</span>
                                        </template>
                                        <template v-else>
                                            <span>{{ a.note || 'ÂÆûÁî®ËÉΩÂäõ' }}</span>
                                        </template>
                                    </div>
                                </div>
                                <div v-if="!uiState.monsterDraft.actions?.length" class="placeholder small">Êó†ÁâπÊÆäËÉΩÂäõÊàñÂä®‰Ωú</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ÁºñËæëÊ®°Âºè -->
                <div v-if="ui.monsterEditor.mode === 'edit'">
                    <div style="display: flex; flex-direction: column; align-items: center; gap: 8px; margin-bottom: 12px;">
                        <input type="file" ref="avatarUpload" @change="onAvatarImageSelect" accept="image/*" hidden>
                        <div class="avatar" style="width: 80px; height: 80px; font-size: 40px; cursor: pointer;" @click="$refs.avatarUpload.click()">
                            <img v-if="uiState.monsterDraft.avatar" :src="uiState.monsterDraft.avatar" alt="Avatar" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
                            <span v-else>üßü</span>
                        </div>
                        <button class="btn small" @click="$refs.avatarUpload.click()">‰∏ä‰º†/Êõ¥Êç¢Â§¥ÂÉè</button>
                    </div>
                    <div class="two-col">
                        <div class="col">
                            <label>ÂêçÁß∞</label>
                            <input class="input" v-model="uiState.monsterDraft.name" placeholder="‰æãÂ¶ÇÔºöÂì•Â∏ÉÊûó" />
                        </div>
                        <div class="col">
                            <label>CR</label>
                            <input type="number" step="0.5" class="input" v-model.number="uiState.monsterDraft.cr" />
                        </div>
                        <div class="col">
                            <label>Á±ªÂûãÔºàÁÇπÂáªÈÄâÊã©Ôºâ</label>
                            <div class="row" style="flex-wrap: wrap; gap: 6px;">
                                <span v-for="typeKey in monsterTypes" 
                                      :key="typeKey" 
                                      class="chip"
                                      :class="{ active: uiState.monsterDraft.type.includes(typeKey) }"
                                      @click="toggleMonsterDraftType(typeKey)">
                                    {{ translateType(typeKey) }}
                                </span>
                            </div>
                        </div>
                        <div class="col">
                            <label>AC</label>
                            <input type="number" class="input" v-model.number="uiState.monsterDraft.ac" />
                        </div>
                        <div class="col">
                            <label>HP Âπ≥Âùá</label>
                            <input type="number" class="input" v-model.number="uiState.monsterDraft.hp.average" />
                        </div>
                        <div class="col">
                            <label>ÈÄüÂ∫¶ÔºàÊ≠•Ë°åÔºâ</label>
                            <input type="number" class="input" v-model.number="uiState.monsterDraft.speed.walk" />
                        </div>
                    </div>

                    <details open>
                        <summary class="section-title">ÂÖ≠Â§ßÂ±ûÊÄß</summary>
                        <div class="ability-grid" style="padding-top: 8px;">
                            <div class="ability" v-for="k in ['str','dex','con','int','wis','cha']" :key="k">
                                <div class="muted small">{{k.toUpperCase()}}</div>
                                <input type="number" class="input" style="width:80px" v-model.number="uiState.monsterDraft.abilities[k]" />
                            </div>
                        </div>
                    </details>

                    <div class="hl"></div>
                    <details>
                        <summary class="section-title">ÊäóÊÄß/Êòì‰º§/ÂÖçÁñ´Ôºà‰º§ÂÆ≥/Áä∂ÊÄÅÔºâ</summary>
                        <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 12px; padding-top: 8px;">
                            <div class="col">
                                <label>‰º§ÂÆ≥ÊäóÊÄß</label>
                                <div class="row" style="flex-wrap: wrap; gap: 6px;">
                                    <span v-for="dt in damageTypes" :key="dt" class="chip"
                                          :class="{active: uiState.monsterDraft.resistances.damage.includes(dt)}"
                                          @click="toggleDamageModifier('resistances', dt)">
                                        {{ dt }}
                                    </span>
                                </div>
                            </div>
                            <div class="col">
                                <label>‰º§ÂÆ≥Êòì‰º§</label>
                                <div class="row" style="flex-wrap: wrap; gap: 6px;">
                                    <span v-for="dt in damageTypes" :key="dt" class="chip"
                                          :class="{active: uiState.monsterDraft.vulnerabilities.damage.includes(dt)}"
                                          @click="toggleDamageModifier('vulnerabilities', dt)">
                                        {{ dt }}
                                    </span>
                                </div>
                            </div>
                            <div class="col">
                                <label>‰º§ÂÆ≥ÂÖçÁñ´</label>
                                <div class="row" style="flex-wrap: wrap; gap: 6px;">
                                    <span v-for="dt in damageTypes" :key="dt" class="chip"
                                          :class="{active: uiState.monsterDraft.immunities.damage.includes(dt)}"
                                          @click="toggleDamageModifier('immunities', dt)">
                                        {{ dt }}
                                    </span>
                                </div>
                            </div>
                            <div class="col">
                                <label>Áä∂ÊÄÅÂÖçÁñ´</label>
                                <div class="row" style="flex-wrap: wrap; gap: 6px;">
                                    <span v-for="ct in conditionTypes" :key="ct" class="chip"
                                          :class="{active: uiState.monsterDraft.immunities.conditions.includes(ct)}"
                                          @click="toggleConditionImmunity(ct)">
                                        {{ ct }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </details>

                    <div class="hl"></div>
                    <details open>
                        <summary class="section-title row">
                            <span>ÁâπÊÆäËÉΩÂäõ/Âä®‰Ωú</span>
                            <div class="spacer"></div>
                            <button class="btn small" @click.prevent="openActionsViewer(uiState.monsterDraft, 'monster')">ÁÆ°ÁêÜÂä®‰Ωú</button>
                        </summary>
                    </details>

                    <div class="hl"></div>
                    <details>
                        <summary class="section-title">CR ‰∏ÄÈîÆË∞ÉÊï¥</summary>
                        <div class="row" style="padding-top: 8px;">
                            <input type="number" step="0.5" class="input" style="width:120px" v-model.number="uiState.targetCR" placeholder="ÁõÆÊ†áCR">
                            <button class="btn" @click="autoAdjustCR()">Ë∞ÉÊï¥</button>
                        </div>
                        <div class="danger-zone small" style="margin-top: 8px;">
                            TODOÔºöÂÆåÂñÑ‚ÄúÊô∫ËÉΩCRË∞ÉÊï¥ÁÆóÊ≥ï‚ÄùÊò†Â∞ÑËßÑÂàô‰∏éËåÉÂõ¥ÂÄºÈöèÊú∫ÁîüÊàê„ÄÅÊ†πÊçÆ‰º§ÂÆ≥/ËΩÆÂèçÁÆó‰º§ÂÆ≥È™∞„ÄÇÁõÆÂâç‰∏∫Âç†‰ΩçÁÆÄÂåñÂÆûÁé∞Ôºå‰æø‰∫éÂêéÁª≠ÊõøÊç¢„ÄÇ
                        </div>
                    </details>
                </div>

                <div class="hl"></div>
                <div class="row">
                    <button class="btn ok" @click="updateMonster()" v-if="uiState.monsterDraft.id">Êõ¥ÊîπÂπ∂ÂÖ≥Èó≠</button>
                    <button class="btn ok" @click="saveMonsterAsNew()">Âè¶Â≠ò‰∏∫Ëá™ÂÆö‰πâ</button>
                    <div class="spacer"></div>
                    <label class="row" style="cursor:pointer; margin-right: 16px;">
                        <input type="checkbox" v-model="uiState.monsterDraft.isDefault">
                        <span>ËÆæÁΩÆ‰∏∫ÈªòËÆ§ÂèÇÊàò</span>
                    </label>
                    <button class="btn" @click="addToBattleFromEditor(uiState.monsterDraft, 'monster')">Âä†ÂÖ•ÊàòÊñóÂπ∂ÂÖ≥Èó≠</button>
                </div>
            </div>
        </div>

        <!-- Ê®°ÊÄÅÔºöËÉΩÂäõÊ±† -->
        <div class="modal-mask" v-if="ui.abilityPool.open" :style="{ zIndex: ui.abilityPool.nested ? 60 : 50 }">
            <div class="modal">
                <div class="row">
                    <div class="title">ÁâπÊÆäËÉΩÂäõÂ∫ì</div>
                    <div class="spacer"></div>
                    <button class="btn" @click="ui.abilityPool.open=false">ÂÖ≥Èó≠</button>
                </div>
                <div class="hl"></div>
                <div class="toolbar">
                    <input class="input" placeholder="ÊêúÁ¥¢ËÉΩÂäõ..." v-model="ui.abilityPool.keyword" />
                    <button class="btn" @click="openAbilityEditor()">+ Êñ∞ËÉΩÂäõ</button>
                </div>
                <div class="grid cards">
                    <div class="card" v-for="ab in filteredAbilities" :key="ab.id">
                        <div class="row">
                            <div class="title">{{ab.name}}</div>
                            <div class="spacer"></div>
                            <button class="btn" @click="attachAbilityToDraft(ab)">Ê∑ªÂä†Âà∞ÂΩìÂâçÊÄ™Áâ©</button>
                            <button class="btn" @click="openAbilityEditor(ab)">ÁºñËæë</button>
                            <button class="btn danger" @click="deleteAbility(ab.id)">Âà†Èô§</button>
                        </div>
                        <div class="muted small" style="margin-top:6px">{{ab.description}}</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ê®°ÊÄÅÔºöÂä®‰ΩúÂ∫ì -->
        <div class="modal-mask" v-if="ui.actionPool.open" :style="{ zIndex: ui.actionPool.nested ? 60 : 50 }">
            <div class="modal">
                <div class="row">
                    <div class="title">Âä®‰ΩúÂ∫ì</div>
                    <div class="spacer"></div>
                    <button class="btn" @click="ui.actionPool.open=false">ËøîÂõûÁßÅÊúâÂ∫ì</button>
                    <button class="btn" @click="ui.actionPool.open=false">ÂÖ≥Èó≠</button>
                </div>
                <div class="hl"></div>
                <div class="toolbar">
                    <input class="input" placeholder="ÊêúÁ¥¢Âä®‰Ωú..." v-model="ui.actionPool.keyword" />
                    <button class="btn" @click="openActionEditor()">+ Êñ∞Âä®‰Ωú</button>
                </div>
                <div class="grid cards">
                    <div class="card" v-for="action in filteredActions" :key="action.id">
                        <div class="row">
                            <div class="title">{{action.name}}</div>
                            <span class="pill right">{{action.type}}</span>
                        </div>
                        <div class="kpi muted small" style="margin-top:6px">
                            <span class="pill" v-if="action.attackBonus">ÊîªÂáª+{{action.attackBonus}}</span>
                            <span class="pill" v-if="action.damages?.length">{{ formatDamages(action.damages) }}</span>
                            <span class="pill" v-if="action.saveDC">Ë±ÅÂÖç DC{{action.saveDC}} {{action.saveAbility}}</span>
                        </div>
                        <div class="hl"></div>
                        <div class="row">
                            <button class="btn" @click="attachActionToDraft(action)">Ê∑ªÂä†Âà∞ÂΩìÂâçÁîüÁâ©</button>
                            <button class="btn" @click="openActionEditor(action)">ÁºñËæë</button>
                            <button class="btn danger" @click="deleteAction(action.id)">Âà†Èô§</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ê®°ÊÄÅÔºöËÉΩÂäõÁºñËæë -->
        <div class="modal-mask" v-if="ui.abilityEditor.open" :style="{ zIndex: ui.abilityEditor.nested ? 70 : 50 }">
            <div class="modal">
                <div class="row">
                    <div class="title">ÁºñËæëËÉΩÂäõ</div>
                    <div class="spacer"></div>
                    <button class="btn" @click="ui.abilityEditor.open=false">ÂÖ≥Èó≠</button>
                </div>
                <div class="hl"></div>
                <div class="col">
                    <label>ÂêçÁß∞</label>
                    <input class="input" v-model="uiState.abilityDraft.name" />
                    <label>ÊèèËø∞</label>
                    <textarea class="input" rows="4" v-model="uiState.abilityDraft.description" placeholder="ËÉΩÂäõËØ¥Êòé..."></textarea>
                    <div class="hl"></div>
                    <button class="btn ok" @click="saveAbility()">‰øùÂ≠òÂπ∂ÂÖ≥Èó≠</button>
                </div>
            </div>
        </div>

        <!-- Ê®°ÊÄÅÔºöPC ÁºñËæë -->
        <div class="modal-mask" v-if="ui.pcEditor.open">
            <div class="modal">
<div class="row">
    <div class="title">PC ËßíËâ≤ËØ¶ÊÉÖ/ÁºñËæëÂô®</div>
    <div class="spacer"></div>
    <button class="btn" @click="ui.pcEditor.mode = ui.pcEditor.mode === 'view' ? 'edit' : 'view'">
        {{ ui.pcEditor.mode === 'view' ? 'ÂàáÊç¢Âà∞ÁºñËæëÊ®°Âºè' : 'ÂàáÊç¢Âà∞Êü•ÁúãÊ®°Âºè' }}
    </button>
    <button class="btn" @click="ui.pcEditor.open=false">ÂÖ≥Èó≠</button>
</div>
<div class="hl"></div>

<!-- Êü•ÁúãÊ®°Âºè -->
<div v-if="ui.pcEditor.mode === 'view'">
    <div class="row">
        <div class="avatar" style="width: 60px; height: 60px; font-size: 30px;">
            <img v-if="uiState.pcDraft.avatar" :src="uiState.pcDraft.avatar" alt="Avatar" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
            <span v-else>üßù</span>
        </div>
        <div class="col">
            <h2 style="margin: 0;">{{ uiState.pcDraft.name }}</h2>
            <div class="kpi muted small" style="margin-top: 8px;">
                <span class="pill">AC {{uiState.pcDraft.ac}}</span>
                <span class="pill">HP {{uiState.pcDraft.hpCurrent}} / {{uiState.pcDraft.hpMax}}</span>
            </div>
        </div>
    </div>

    <div class="hl"></div>
    
    <div class="section-title">ÂÖ≠Â§ßÂ±ûÊÄß</div>
    <div class="ability-grid">
        <div class="ability" v-for="(v,k) in uiState.pcDraft.abilities" :key="k">
            <div class="muted small">{{k.toUpperCase()}}</div>
            <div style="font-weight:700">{{v}} ({{mod(v)>=0?'+':''}}{{mod(v)}})</div>
        </div>
    </div>

    <div class="hl"></div>

    <div class="three-col">
        <div class="col">
            <div class="section-title">‰º§ÂÆ≥ÊäóÊÄß</div>
            <div class="muted small">{{ (uiState.pcDraft.resistances.damage || []).join(', ') || 'Êó†' }}</div>
        </div>
        <div class="col">
            <div class="section-title">‰º§ÂÆ≥Êòì‰º§</div>
            <div class="muted small">{{ (uiState.pcDraft.vulnerabilities.damage || []).join(', ') || 'Êó†' }}</div>
        </div>
        <div class="col">
            <div class="section-title">‰º§ÂÆ≥ÂÖçÁñ´</div>
            <div class="muted small">{{ (uiState.pcDraft.immunities.damage || []).join(', ') || 'Êó†' }}</div>
        </div>
        <div class="col">
            <div class="section-title">Áä∂ÊÄÅÂÖçÁñ´</div>
            <div class="muted small">{{ (uiState.pcDraft.immunities.conditions || []).join(', ') || 'Êó†' }}</div>
        </div>
    </div>

    <div class="hl"></div>
    <div class="section-title">ÁâπÊÄß</div>
    <div class="muted small" style="white-space: pre-wrap; background: #1a1d21; padding: 8px; border-radius: 8px;">{{ uiState.pcDraft.features || 'Êó†' }}</div>

    <div class="hl"></div>

    <div class="section-title">Âä®‰Ωú</div>
    <div class="grid" style="gap: 8px;">
        <div class="card" v-for="a in uiState.pcDraft.actions" :key="a.id">
            <div class="row">
                <div class="title">{{ a.name }}</div>
                <div class="spacer"></div>
                <span class="tag">{{ a.type }}</span>
            </div>
            <div class="muted small" style="margin-top: 6px;">
                <template v-if="a.type === 'attack'">
                    <span>ÊîªÂáª+{{ a.attackBonus }}</span>,
                    <span v-if="a.range">Ë∑ùÁ¶ª: {{ a.range }}</span>,
                    <span>‰º§ÂÆ≥: {{ formatDamages(a.damages) }}</span>
                </template>
                <template v-else-if="a.type === 'save'">
                    <span>Ë±ÅÂÖçDC {{ a.saveDC }} {{ a.saveAbility?.toUpperCase() }}</span>,
                    <span>‰º§ÂÆ≥: {{ formatDamages(a.damages) }}</span>
                </template>
                <template v-else>
                    <span>{{ a.note || 'ÂÆûÁî®ËÉΩÂäõ' }}</span>
                </template>
            </div>
        </div>
        <div v-if="!uiState.pcDraft.actions?.length" class="placeholder small">Êó†Âä®‰Ωú</div>
    </div>
    <div class="hl"></div>
    <div class="row">
        <button class="btn ok" @click="savePC()">‰øùÂ≠òÂπ∂ÂÖ≥Èó≠</button>
        <div class="spacer"></div>
        <button class="btn" @click="addToBattleFromEditor(uiState.pcDraft, 'pc')">Âä†ÂÖ•ÊàòÊñóÂπ∂ÂÖ≥Èó≠</button>
    </div>
</div>

<!-- ÁºñËæëÊ®°Âºè -->
<div v-if="ui.pcEditor.mode === 'edit'">
    <div style="display: flex; flex-direction: column; align-items: center; gap: 8px; margin-bottom: 12px;">
        <input type="file" ref="pcAvatarUpload" @change="onAvatarImageSelect" accept="image/*" hidden>
        <div class="avatar" style="width: 80px; height: 80px; font-size: 40px; cursor: pointer;" @click="$refs.pcAvatarUpload.click()">
            <img v-if="uiState.pcDraft.avatar" :src="uiState.pcDraft.avatar" alt="Avatar" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
            <span v-else>üßù</span>
        </div>
        <button class="btn small" @click="$refs.pcAvatarUpload.click()">‰∏ä‰º†/Êõ¥Êç¢Â§¥ÂÉè</button>
    </div>
    <div class="two-col">
        <div class="col"><label>ÂêçÁß∞</label><input class="input" v-model="uiState.pcDraft.name" /></div>
        <div class="col"><label>AC</label><input type="number" class="input" v-model.number="uiState.pcDraft.ac" /></div>
        <div class="col"><label>HP ÊúÄÂ§ß</label><input type="number" class="input" v-model.number="uiState.pcDraft.hpMax" /></div>
        <div class="col"><label>HP ÂΩìÂâç</label><input type="number" class="input" v-model.number="uiState.pcDraft.hpCurrent" /></div>
    </div>
    <div class="section-title">ÂÖ≠Â§ßÂ±ûÊÄß</div>
    <div class="ability-grid">
        <div class="ability" v-for="k in ['str','dex','con','int','wis','cha']" :key="k">
            <div class="muted small">{{k.toUpperCase()}}</div>
            <input type="number" class="input" style="width:80px" v-model.number="uiState.pcDraft.abilities[k]" />
        </div>
    </div>

    <details>
        <summary class="section-title">ÊäóÊÄß/Êòì‰º§/ÂÖçÁñ´Ôºà‰º§ÂÆ≥/Áä∂ÊÄÅÔºâ</summary>
        <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 12px; padding-top: 8px;">
            <div class="col">
                <label>‰º§ÂÆ≥ÊäóÊÄß</label>
                <div class="row" style="flex-wrap: wrap; gap: 6px;">
                    <span v-for="dt in damageTypes" :key="dt" class="chip"
                          :class="{active: uiState.pcDraft.resistances.damage.includes(dt)}"
                          @click="toggleDamageModifier('resistances', dt)">
                        {{ dt }}
                    </span>
                </div>
            </div>
            <div class="col">
                <label>‰º§ÂÆ≥Êòì‰º§</label>
                <div class="row" style="flex-wrap: wrap; gap: 6px;">
                    <span v-for="dt in damageTypes" :key="dt" class="chip"
                          :class="{active: uiState.pcDraft.vulnerabilities.damage.includes(dt)}"
                          @click="toggleDamageModifier('vulnerabilities', dt)">
                        {{ dt }}
                    </span>
                </div>
            </div>
            <div class="col">
                <label>‰º§ÂÆ≥ÂÖçÁñ´</label>
                <div class="row" style="flex-wrap: wrap; gap: 6px;">
                    <span v-for="dt in damageTypes" :key="dt" class="chip"
                          :class="{active: uiState.pcDraft.immunities.damage.includes(dt)}"
                          @click="toggleDamageModifier('immunities', dt)">
                        {{ dt }}
                    </span>
                </div>
            </div>
            <div class="col">
                <label>Áä∂ÊÄÅÂÖçÁñ´</label>
                <div class="row" style="flex-wrap: wrap; gap: 6px;">
                    <span v-for="ct in conditionTypes" :key="ct" class="chip"
                          :class="{active: uiState.pcDraft.immunities.conditions.includes(ct)}"
                          @click="toggleConditionImmunity(ct)">
                        {{ ct }}
                    </span>
                </div>
            </div>
        </div>
    </details>

    <div class="section-title row">
        <span>ÁâπÊÄß</span>
    </div>
    <textarea class="input underline-input" rows="3" v-model="uiState.pcDraft.features" placeholder="ËæìÂÖ•ËßíËâ≤ÁöÑÁâπÊÄß„ÄÅËÉåÊôØ„ÄÅÂÖ≥ÈîÆ‰ø°ÊÅØÁ≠â..."></textarea>

    <div class="section-title row">
        <span>Âä®‰Ωú</span>
        <div class="spacer"></div>
        <button class="btn small" @click.prevent="openActionsViewer(uiState.pcDraft, 'pc')">ÁÆ°ÁêÜÂä®‰Ωú</button>
    </div>

    <div class="hl"></div>
    <div class="row">
        <button class="btn ok" @click="savePC()">‰øùÂ≠òÂπ∂ÂÖ≥Èó≠</button>
        <div class="spacer"></div>
        <label class="row" style="cursor:pointer; margin-right: 16px;">
            <input type="checkbox" v-model="uiState.pcDraft.isDefault">
            <span>ËÆæÁΩÆ‰∏∫ÈªòËÆ§ÂèÇÊàò</span>
        </label>
        <button class="btn" @click="addToBattleFromEditor(uiState.pcDraft, 'pc')">Âä†ÂÖ•ÊàòÊñóÂπ∂ÂÖ≥Èó≠</button>
    </div>
</div>
            </div>
        </div>

<!-- Ê®°ÊÄÅÔºöÂä®‰ΩúÁºñËæë -->
        <div class="modal-mask" v-if="ui.actionEditor.open" :style="{ zIndex: ui.actionEditor.nested ? 65 : 50 }">
            <div class="modal">
                <div class="row">
                    <div class="title">ÁºñËæëÂä®‰Ωú</div>
                    <div class="spacer"></div>
                    <button class="btn" @click="ui.actionEditor.open=false">ÂÖ≥Èó≠</button>
                </div>
                <div class="hl"></div>
                <div class="col">
                    <div class="row">
                        <div class="col">
                            <label>Âä®‰ΩúÂêçÁß∞</label>
                            <input class="input" style="min-width:160px" v-model="uiState.actionDraft.name" placeholder="Âä®‰ΩúÂêçÁß∞" />
                        </div>
                        <div class="col">
                            <label>Á±ªÂûã</label>
                            <select class="input" v-model="uiState.actionDraft.type">
                                <option value="attack">ÊîªÂáªÊ£ÄÂÆö</option>
                                <option value="save">Ë±ÅÂÖçÊ£ÄÂÆö</option>
                                <option value="utility">ÂÖ∂‰ªñ</option>
                            </select>
                        </div>
                    </div>
                    <div class="hl"></div>
                    <div class="row small" style="gap:12px">
                        <template v-if="uiState.actionDraft.type==='attack'">
                            <div class="col">
                                <label>ÊîªÂáªÂä†ÂÄº</label>
                                <input type="number" class="input" style="width:90px" v-model.number="uiState.actionDraft.attackBonus" />
                            </div>
                            <div class="col">
                                <label>ÊîªÂáªË∑ùÁ¶ª</label>
                                <input class="input" style="width:90px" v-model="uiState.actionDraft.range" placeholder="‰æãÂ¶Ç 5 ft." />
                            </div>
                            <div class="col" style="grid-column: span 2;">
                                <div class="row">
                                    <label>Â§öÊÆµ‰º§ÂÆ≥</label>
                                    <div class="spacer"></div>
                                    <button class="btn small" @click="addDamageToActionDraft()">+ Ê∑ªÂä†‰º§ÂÆ≥</button>
                                 </div>
                                <div v-for="(damage, index) in uiState.actionDraft.damages" :key="damage.id" class="row" style="margin-top: 4px;">
                                    <input class="input mono" style="width:120px" v-model="damage.dice" placeholder="‰æãÂ¶Ç 2d6+3" />
                                    <select class="input" v-model="damage.type">
                                        <option v-for="dt in damageTypes" :key="dt" :value="dt">{{dt}}</option>
                                    </select>
                                    <button v-if="index > 0" class="btn danger small" @click="confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ê≠§ÊÆµ‰º§ÂÆ≥ÂêóÔºü') && uiState.actionDraft.damages.splice(index, 1)">Âà†Èô§</button>
                                </div>
                            </div>
                            <div class="col">
                                <label>ÂÖÖËÉΩÂõûÂêà</label>
                                <input type="number" class="input" style="width:90px" v-model.number="uiState.actionDraft.recharge" placeholder="0" />
                            </div>
                            <div class="col">
                                <label>ÂëΩ‰∏≠ÈôÑÂä†Áä∂ÊÄÅ</label>
                                <select class="input" v-model="uiState.actionDraft.onHitStatus">
                                    <option value="">Êó†</option>
                                    <option v-for="s in statusCatalog" :key="s.name" :value="s.name">{{s.name}}</option>
                                </select>
                                <div v-if="uiState.actionDraft.onHitStatus" class="form-row">
                                  <label>
                                    Ë±ÅÂÖçÂ±ûÊÄß:
                                    <select v-model="uiState.actionDraft.onHitSaveAbility">
                                      <option value="str">ÂäõÈáè (Strength)</option>
                                      <option value="dex">ÊïèÊç∑ (Dexterity)</option>
                                      <option value="con">‰ΩìË¥® (Constitution)</option>
                                      <option value="int">Êô∫Âäõ (Intelligence)</option>
                                      <option value="wis">ÊÑüÁü• (Wisdom)</option>
                                      <option value="cha">È≠ÖÂäõ (Charisma)</option>
                                    </select>
                                  </label>
                                  <label>
                                    Ë±ÅÂÖçDC:
                                    <input type="number" v-model.number="uiState.actionDraft.onHitSaveDC" style="width: 60px;">
                                  </label>
                                </div>
                            </div>
                            <div class="col" v-if="uiState.actionDraft.onHitStatus">
                                <label>Áä∂ÊÄÅÊåÅÁª≠ÂõûÂêà</label>
                                <input type="number" class="input" style="width:90px" v-model.number="uiState.actionDraft.onHitStatusRounds" placeholder="ÈªòËÆ§1" />
                            </div>
                        </template>
                        <template v-else-if="uiState.actionDraft.type==='save'">
                            <div class="col">
                                <label>Ë±ÅÂÖçÂ±ûÊÄß</label>
                                <select class="input" v-model="uiState.actionDraft.saveAbility">
                                    <option>str</option>
                                    <option>dex</option>
                                    <option>con</option>
                                    <option>int</option>
                                    <option>wis</option>
                                    <option>cha</option>
                                </select>
                            </div>
                            <div class="col">
                                <label>DC</label>
                                <input type="number" class="input" style="width:90px" v-model.number="uiState.actionDraft.saveDC" />
                            </div>
                             <div class="col" style="grid-column: span 2;">
                                <div class="row">
                                    <label>Â§öÊÆµ‰º§ÂÆ≥</label>
                                    <div class="spacer"></div>
                                    <button class="btn small" @click="addDamageToActionDraft()">+ Ê∑ªÂä†‰º§ÂÆ≥</button>
                                 </div>
                                <div v-for="(damage, index) in uiState.actionDraft.damages" :key="damage.id" class="row" style="margin-top: 4px;">
                                    <input class="input mono" style="width:120px" v-model="damage.dice" placeholder="‰æãÂ¶Ç 2d6+3" />
                                    <select class="input" v-model="damage.type">
                                        <option v-for="dt in damageTypes" :key="dt" :value="dt">{{dt}}</option>
                                    </select>
                                    <button v-if="index > 0" class="btn danger small" @click="confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ê≠§ÊÆµ‰º§ÂÆ≥ÂêóÔºü') && uiState.actionDraft.damages.splice(index, 1)">Âà†Èô§</button>
                                </div>
                            </div>
                            <div class="col">
                                <label>ÂÖÖËÉΩÂõûÂêà</label>
                                <input type="number" class="input" style="width:90px" v-model.number="uiState.actionDraft.recharge" placeholder="0" />
                            </div>
                            <div class="col">
                                <label>ÊàêÂäüÊòØÂê¶Âçä‰º§</label>
                                <select class="input" v-model="uiState.actionDraft.onSuccess">
                                    <option value="half">Âçä‰º§</option>
                                    <option value="none">ÂÖçÁñ´</option>
                                </select>
                            </div>
                        </template>
                        <template v-else>
                            <span class="muted">ÂÆûÁî®Âä®‰ΩúÔºåÊó†Ëá™Âä®ÁªìÁÆó</span>
                        </template>
                    </div>
                    <div class="hl"></div>
                    <button class="btn ok" @click="saveAction()">‰øùÂ≠òÂπ∂ÂÖ≥Èó≠</button>
                </div>
            </div>
        </div>

        <!-- Ê®°ÊÄÅÔºöÁä∂ÊÄÅÈÄâÊã©Âô® -->
        <div class="modal-mask" v-if="ui.statusPicker.open">
            <div class="modal">
                <div class="row">
                    <div class="title">ÊñΩÂä†Áä∂ÊÄÅ</div>
                    <div class="spacer"></div>
                    <button class="btn" @click="ui.statusPicker.open=false">ÂÖ≥Èó≠</button>
                </div>
                <div class="hl"></div>
                <div class="row">
                    <select class="input" v-model="ui.statusPicker.selectedName">
                        <option v-for="s in statusCatalog" :key="s.name" :value="s.name">{{s.name}}</option>
                    </select>
                    <input type="number" class="input" style="width:120px" v-model.number="ui.statusPicker.rounds" placeholder="ÊåÅÁª≠ÂõûÂêàÊï∞">
                    <input class="input" style="width:120px" v-model="ui.statusPicker.icon" placeholder="ÂõæÊ†á(emoji ÂèØ)">
                    <button class="btn ok" @click="applyStatus()">Â∫îÁî®</button>
                </div>
                <div class="ok-zone small" style="margin-top:8px">
                    Â∑≤ÊîØÊåÅËá™Âä®ËøΩË∏™Áä∂ÊÄÅÊó∂ÈïøÔºåÊØèÂà∞ÂõûÂêàÂºÄÂßãËá™Âä® -1ÔºåËá≥ 0 Ëá™Âä®ÁßªÈô§„ÄÇ‰πüÂèØÊâãÂä®ÁßªÈô§ÊàñË∞ÉÊï¥„ÄÇ
                </div>
            </div>
        </div>

        <!-- Ê®°ÊÄÅÔºöÂõæÁâáË£ÅÂâ™ -->
        <div class="modal-mask" v-if="ui.imageCropper.open" style="z-index: 60;">
            <div class="modal" ref="cropperModal">
                <div class="title">Ë£ÅÂâ™ÂõæÁâá</div>
                <div class="hl"></div>
                <div style="max-height: 60vh; overflow: auto; text-align: center; position: relative;">
                    <canvas ref="cropperCanvas" @mousedown="startDrag" @mousemove="drag" @mouseup="endDrag" @mouseleave="endDrag"></canvas>
                </div>
                <div class="hl"></div>
                <div class="row">
                    <button class="btn ok" @click="confirmCrop()">Á°ÆËÆ§Ë£ÅÂâ™</button>
                    <div class="spacer"></div>
                    <button class="btn" @click="ui.imageCropper.open = false">ÂèñÊ∂à</button>
                </div>
            </div>
        </div>

        <!-- Ê®°ÊÄÅÔºöÂ§¥ÂÉèË£ÅÂâ™ -->
        <div class="modal-mask" v-if="ui.avatarCropper.open" style="z-index: 60;">
            <div class="modal" ref="avatarCropperModal">
                <div class="title">Ë£ÅÂâ™Â§¥ÂÉè</div>
                <div class="hl"></div>
                <div style="max-height: 60vh; overflow: auto; text-align: center; position: relative;">
                    <canvas ref="avatarCropperCanvas" @mousedown="startDrag" @mousemove="drag" @mouseup="endDrag" @mouseleave="endDrag"></canvas>
                </div>
                <div class="hl"></div>
                <div class="row">
                    <button class="btn ok" @click="confirmAvatarCrop()">Á°ÆËÆ§Ë£ÅÂâ™</button>
                    <div class="spacer"></div>
                    <button class="btn" @click="ui.avatarCropper.open = false">ÂèñÊ∂à</button>
                </div>
            </div>
        </div>

        <!-- Ê®°ÊÄÅÔºöHP ÁºñËæë -->
        <div class="modal-mask" v-if="ui.hpEditor.open">
            <div class="modal">
                <div class="row">
                    <div class="title">ÁºñËæëHP</div>
                    <div class="spacer"></div>
                    <button class="btn" @click="ui.hpEditor.open=false">ÂÖ≥Èó≠</button>
                </div>
                <div class="hl"></div>
                <div class="row">
                    <input class="input mono" style="width:120px" v-model.number="ui.hpEditor.delta" placeholder="+/-HP">
                    <button class="btn" @click="applyHPDelta(battle.participants.find(p=>p.uid===ui.hpEditor.targetUid), ui.hpEditor.delta); ui.hpEditor.open=false">Â∫îÁî®</button>
                    <button class="btn" @click="applyHPDelta(battle.participants.find(p=>p.uid===ui.hpEditor.targetUid), Math.floor((ui.hpEditor.delta||0)/2)); ui.hpEditor.open=false">Âçä‰º§</button>
                    <button class="btn" @click="applyHPDelta(battle.participants.find(p=>p.uid===ui.hpEditor.targetUid), (ui.hpEditor.delta||0)*2); ui.hpEditor.open=false">ÂèåÂÄç</button>
                    <button class="btn ok" @click="applyHPDelta(battle.participants.find(p=>p.uid===ui.hpEditor.targetUid), Math.abs(ui.hpEditor.delta||0)); ui.hpEditor.open=false">Ê≤ªÁñó</button>
                </div>
            </div>
        </div>
        <!-- Ê®°ÊÄÅÔºöÂø´ÈÄüÊâ£Ë°ÄÔºàÂäüËÉΩ‰øÆÂ§çÁâàÔºâ -->
        <div class="modal-mask" v-if="ui.quickDamage.open">
            <div class="modal" style="max-width: 400px;">
                <form @submit.prevent="applyQuickDamage">
                    <div class="row">
                        <div class="title">Âø´ÈÄüÊâ£Ë°Ä: {{ ui.quickDamage.targetName }}</div>
                        <div class="spacer"></div>
                        <button class="btn" type="button" @click="closeQuickDamageEditor">ÂÖ≥Èó≠</button>
                    </div>
                    <div class="hl"></div>
                    <div class="col">
                        <label>ËæìÂÖ•Ë¶ÅÊâ£Èô§ÁöÑÁîüÂëΩÂÄºÔºà‰ªÖÊï∞Â≠óÔºâ</label>
                        <input ref="quickDamageInput" class="input mono" style="margin-top: 8px;" type="number" v-model.number="ui.quickDamage.damageAmount" placeholder="‰æãÂ¶Ç: 15">
                    </div>
                    <div class="hl"></div>
                    <div class="row">
                        <div class="spacer"></div>
                        <button class="btn primary" type="submit">Á°ÆËÆ§Êâ£Ë°Ä</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Ê®°ÊÄÅÔºöÊÄ™Áâ©ÁªÑÂêàÁÆ°ÁêÜÂô® -->
        <div class="modal-mask" v-if="ui.monsterGroupManager.open">
            <div class="modal">
                <div class="row">
                    <div class="title">ÊÄ™Áâ©ÁªÑÂêàÁÆ°ÁêÜ</div>
                    <div class="spacer"></div>
                    <button class="btn" @click="ui.monsterGroupManager.open=false">ÂÖ≥Èó≠</button>
                </div>
                <div class="hl"></div>
                <div class="toolbar">
                    <button class="btn primary" @click="openGroupEditor()">+ Êñ∞Âª∫ÁªÑ</button>
                </div>
                <div class="grid cards">
                    <div class="card" v-for="group in monsterGroups" :key="group.id">
                        <div class="title">{{ group.name }}</div>
                        <div class="muted small" style="margin-top: 6px;">
                            ÂåÖÂê´ {{ group.monsters.reduce((acc, m) => acc + m.count, 0) }} ‰∏™ÊÄ™Áâ©
                        </div>
                        <div class="hl"></div>
                        <div class="row">
                            <button class="btn" @click="openGroupEditor(group)">ËÆæÁΩÆ</button>
                            <div class="spacer"></div>
                            <button class="btn danger" @click="deleteGroup(group.id)">Âà†Èô§ÁªÑ</button>
                        </div>
                    </div>
                    <div v-if="!monsterGroups.length" class="placeholder">ÊöÇÊó†ÁªÑÂêàÔºåËØ∑Êñ∞Âª∫„ÄÇ</div>
                </div>
            </div>
        </div>

        <!-- Ê®°ÊÄÅÔºöÊÄ™Áâ©ÁªÑÂêàÁºñËæëÂô® -->
        <div class="modal-mask" v-if="ui.monsterGroupEditor.open" style="z-index: 55;">
            <div class="modal" style="max-width: 960px;">
                <div class="row">
                    <div class="title">{{ uiState.groupDraft.id ? 'ÁºñËæë' : 'Êñ∞Âª∫' }}ÊÄ™Áâ©ÁªÑÂêà</div>
                    <div class="spacer"></div>
                    <button class="btn" @click="ui.monsterGroupEditor.open=false">ÂÖ≥Èó≠</button>
                </div>
                <div class="hl"></div>
                <div class="col" style="margin-bottom: 12px;">
                    <label>ÁªÑÂêàÂêçÁß∞</label>
                    <input class="input" v-model="uiState.groupDraft.name" placeholder="‰æãÂ¶ÇÔºöÂì•Â∏ÉÊûóÂ∑°ÈÄªÈòü" />
                </div>
                <div class="two-col">
                    <!-- Â∑¶‰æßÔºöÈÄâÊã©ÊÄ™Áâ© -->
                    <div class="pane" style="max-height: 50vh; overflow: auto; background: var(--bg);">
                        <div class="sticky-toolbar" style="top: -12px; padding: 8px; margin: -12px -12px 8px -12px;">
                             <input class="input" v-model="ui.monsterGroupEditor.keyword" placeholder="ÊêúÁ¥¢ÊÄ™Áâ©..." style="width: 100%;" />
                        </div>
                        <div class="grid" style="gap: 8px;">
                            <div class="row" v-for="m in filteredMonstersForGroup" :key="m.id">
                                <span>{{m.name}} <span class="muted small">CR {{m.cr}}</span></span>
                                <div class="spacer"></div>
                                <button class="btn small" @click="addMonsterToGroupDraft(m)">+ Ê∑ªÂä†</button>
                            </div>
                        </div>
                    </div>
                    <!-- Âè≥‰æßÔºöÂ∑≤ÈÄâÊÄ™Áâ© -->
                    <div class="pane" style="max-height: 50vh; overflow: auto; background: var(--bg);">
                        <div class="section-title">ÁªÑÂÜÖÊÄ™Áâ©</div>
                        <div class="grid" style="gap: 8px;">
                            <div class="row" v-for="(gm, index) in uiState.groupDraft.monsters" :key="gm.monsterId + '-' + index">
                                <span>{{ gm.name }}</span>
                                <div class="spacer"></div>
                                <input type="number" class="input small" style="width: 80px" v-model.number="gm.count" min="1">
                                <button class="btn danger small" @click="uiState.groupDraft.monsters.splice(index, 1)">ÁßªÈô§</button>
                            </div>
                            <div v-if="!uiState.groupDraft.monsters.length" class="placeholder small">ËØ∑‰ªéÂ∑¶‰æßÊ∑ªÂä†ÊÄ™Áâ©</div>
                        </div>
                    </div>
                </div>
                <div class="hl"></div>
                <div class="row">
                    <button class="btn ok" @click="saveGroup()">ÂÆåÊàêÂπ∂‰øùÂ≠ò</button>
                </div>
            </div>
        </div>

        <!-- Ê®°ÊÄÅÔºöÊ∑ªÂä†ÂèÇÊàòÂçï‰Ωç -->
        <div class="modal-mask" v-if="ui.addParticipants.open">
            <div class="modal" style="max-width: 1024px;">
                <div class="row">
                    <div class="title">Ê∑ªÂä†ÂèÇÊàòÂçï‰Ωç</div>
                    <div class="spacer"></div>
                    <button class="btn" @click="ui.addParticipants.open=false">ÂÖ≥Èó≠</button>
                </div>
                <div class="hl"></div>
                <div class="three-col">
                    <div>
                        <div class="section-title">‰ªéÊÄ™Áâ©Â∫ìÊ∑ªÂä†</div>
                        <input class="input" placeholder="ÊêúÁ¥¢ÊÄ™Áâ©..." v-model="ui.addParticipants.keywordM" />
                        <div class="grid" style="margin-top:8px;max-height:260px;overflow:auto">
                            <div class="row" v-for="m in monsters.filter(x=>!ui.addParticipants.keywordM || x.name.includes(ui.addParticipants.keywordM))" :key="m.id">
                                <span>{{m.name}} <span class="muted small">CR {{m.cr}}</span></span>
                                <div class="spacer"></div>
                                <input type="number" class="input small" style="width:90px" v-model.number="m._addCount" placeholder="Êï∞Èáè">
                                <button class="btn small" @click="addParticipantsFromMonster(m, m._addCount||1)">Ê∑ªÂä†</button>
                            </div>
                        </div>
                    </div>
                    <div>
                        <div class="section-title">‰ªéPCÂ∫ìÊ∑ªÂä†</div>
                        <input class="input" placeholder="ÊêúÁ¥¢PC..." v-model="ui.addParticipants.keywordP" />
                        <div class="grid" style="margin-top:8px;max-height:260px;overflow:auto">
                            <div class="row" v-for="pc in pcs.filter(x=>!ui.addParticipants.keywordP || x.name.includes(ui.addParticipants.keywordP))" :key="pc.id">
                                <span>{{pc.name}}</span>
                                <div class="spacer"></div>
                                <button class="btn small" @click="addParticipantsFromPC(pc)">Ê∑ªÂä†</button>
                            </div>
                        </div>
                    </div>
                    <!-- ËøôÊòØÁ¨¨‰∏âÂàóÔºåÁî®‰∫éÁªÑÂêàÂá∫Êàò -->
                    <div>
                        <div class="section-title">‰ªéÁªÑÂêàÂá∫Êàò</div>
                        <div class="grid" style="margin-top:8px;max-height:260px;overflow:auto">
                            <div class="row" v-for="group in monsterGroups" :key="group.id">
                                <span>{{group.name}}</span>
                                <div class="spacer"></div>
                                <button class="btn small" @click="addParticipantsFromGroup(group)">Ê∑ªÂä†</button>
                            </div>
                            <div v-if="!monsterGroups.length" class="placeholder small">Â∞öÊú™ËÆæÁΩÆ‰ªª‰ΩïÁªÑÂêà</div>
                        </div>
                    </div>
                </div>
                <div class="hl"></div>
                <div class="ok-zone small">ÊèêÁ§∫ÔºöÂêåÂêçÊÄ™Áâ©‰ºöËá™Âä®ÂàÜÁªÑ„ÄÇ‰Ω†‰πüÂèØ‰ª•Âú®Âçï‰Ωç‰∏äÊâãÂä®ËÆæÂÆö groupName„ÄÇ</div>
            </div>
        </div>

        <!-- Ê®°ÊÄÅÔºöË±ÅÂÖçÊ£ÄÂÆö -->
        <div v-if="ui.saveCheck.open" class="modal-mask">
          <div class="modal-wrapper">
            <div class="modal-container">
              <div class="modal-header">
                <h3>Ë±ÅÂÖçÊ£ÄÂÆö</h3>
              </div>
              <div class="modal-body">
                <p>ÁõÆÊ†á <strong>{{ ui.saveCheck.targetName }}</strong> ÈúÄË¶ÅËøõË°å‰∏ÄÊ¨° <strong>DC {{ ui.saveCheck.dc }}</strong> ÁöÑ <strong>{{ ui.saveCheck.ability.toUpperCase() }}</strong> Ë±ÅÂÖçÊ£ÄÂÆö„ÄÇ</p>
                <p>ËØ∑ÊäïÊé∑d20Âπ∂Âä†‰∏äÁõÆÊ†áÁöÑË±ÅÂÖçË∞ÉÊï¥ÂÄº„ÄÇ</p>
              </div>
              <div class="modal-footer">
                <button class="modal-default-button" @click="ui.saveCheck.callback(true)">
                  Ë±ÅÂÖçÊàêÂäü
                </button>
                <button class="modal-default-button" @click="ui.saveCheck.callback(false)">
                  Ë±ÅÂÖçÂ§±Ë¥•
                </button>
              </div>
            </div>
            </div>
        </div>

        <!-- Ê®°ÊÄÅÔºöË±ÅÂÖçÁªìÊûúÈÄâÊã©Âô® -->
        <div class="modal-mask" v-if="ui.saveOutcomePicker.open">
            <div class="modal">
                <div class="row">
                    <div class="title">{{ ui.saveOutcomePicker.title }}</div>
                    <div class="spacer"></div>
                    <button class="btn" @click="ui.saveOutcomePicker.open=false">ÂèñÊ∂à</button>
                </div>
                <div class="hl"></div>
                <div class="col" style="gap: 12px; max-height: 60vh; overflow-y: auto; padding: 4px;">
                    <p class="muted small">ËØ∑‰∏∫ÊØè‰∏™ÁõÆÊ†áÈÄâÊã©Ë±ÅÂÖçÊ£ÄÂÆöÁöÑÁªìÊûú„ÄÇÊÄªÊΩúÂú®‰º§ÂÆ≥: **{{ formatRolledDamages(ui.saveOutcomePicker.damages) }}**</p>
                    <div v-for="target in ui.saveOutcomePicker.targets" :key="target.uid" class="card">
                        <div class="row">
                            <div class="avatar">
                                <img v-if="target.avatar" :src="target.avatar" :alt="target.name">
                                <span v-else>üéØ</span>
                            </div>
                            <strong style="margin-left: 8px;">{{ target.name }}</strong>
                            <div class="spacer"></div>
                            <div class="row">
                                <label class="chip" :class="{active: ui.saveOutcomePicker.outcomes[target.uid] === 'fail'}">
                                    <input type="radio" :name="'outcome-' + target.uid" value="fail" v-model="ui.saveOutcomePicker.outcomes[target.uid]"> Ë±ÅÂÖçÂ§±Ë¥•
                                </label>
                                <label class="chip" :class="{active: ui.saveOutcomePicker.outcomes[target.uid] === 'half'}">
                                    <input type="radio" :name="'outcome-' + target.uid" value="half" v-model="ui.saveOutcomePicker.outcomes[target.uid]"> ‰º§ÂÆ≥ÂáèÂçä
                                </label>
                                <label class="chip" :class="{active: ui.saveOutcomePicker.outcomes[target.uid] === 'zero'}">
                                    <input type="radio" :name="'outcome-' + target.uid" value="zero" v-model="ui.saveOutcomePicker.outcomes[target.uid]"> ‰º§ÂÆ≥ÂÖ®ÂÖç
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="hl"></div>
                <div class="row">
                    <div class="spacer"></div>
                    <button class="btn ok" @click="applySaveOutcomes()">Á°ÆËÆ§Âπ∂Â∫îÁî®ÁªìÊûú</button>
                </div>
            </div>
        </div>

        <!-- Ê®°ÊÄÅÔºöÂä®‰ΩúÁÆ°ÁêÜ -->
        <div class="modal-mask" v-if="ui.actionsViewer.open" style="z-index: 55;">
            <div class="modal">
                <div class="row">
                    <div class="title">ÁÆ°ÁêÜÂä®‰Ωú (ÁßÅÊúâÂ∫ì)</div>
                    <div class="spacer"></div>
                </div>
                <div class="hl"></div>
                <div class="pane" style="max-height: 60vh; overflow-y: auto; background: var(--bg); padding: 8px;">
                    <div class="grid cards">
                        <div class="card" v-for="(a, idx) in ui.actionsViewer.draft.actions" :key="a.id">
                            <div class="row">
                                <div class="title">{{a.name}}</div>
                                <span class="pill right">{{a.type}}</span>
                                <div class="spacer"></div>
                                <button class="btn" @click="openActionEditorForDraft(a)">ÁºñËæë</button>
                                <button class="btn danger" @click="ui.actionsViewer.draft.actions.splice(idx,1)">Âà†Èô§</button>
                            </div>
                            <div class="kpi muted small" style="margin-top:6px">
                                <span class="pill" v-if="a.attackBonus">ÊîªÂáª+{{a.attackBonus}}</span>
                                <span class="pill" v-if="a.range">Ë∑ùÁ¶ª: {{a.range}}</span>
                                <span class="pill" v-if="a.damages?.length">{{ formatDamages(a.damages) }}</span>
                                <span class="pill" v-if="a.saveDC">Ë±ÅÂÖç DC{{a.saveDC}} {{a.saveAbility}}</span>
                            </div>
                        </div>
                        <div v-if="!ui.actionsViewer.draft.actions?.length" class="placeholder small">ÊöÇÊó†Âä®‰Ωú</div>
                    </div>
                </div>
                <div class="hl"></div>
                <div class="row">
                    <button class="btn primary" @click="openActionEditorForDraft()">+ Êñ∞Âª∫ÁßÅÊúâÂä®‰Ωú</button>
                    <button class="btn" @click="openActionPool()">‰ªéÂä®‰ΩúÂ∫ìÊ∑ªÂä†</button>
                    <button class="btn" @click="openAbilityPool()">‰ªéËÉΩÂäõÊ±†Ê∑ªÂä†</button>
                    <div class="spacer"></div>
                    <button class="btn ok" @click="ui.actionsViewer.open = false">ÂÆåÊàêÂπ∂ÂÖ≥Èó≠</button>
                </div>
            </div>
        </div>

        <!-- Ê®°ÊÄÅÔºöÂ§ßÊàêÂäü/Â§ßÂ§±Ë¥•ÊèêÁ§∫ -->
        <div v-if="ui.critNotification.open" class="crit-notification-mask">
            <div class="crit-notification-modal" :class="ui.critNotification.type">
                <div class="crit-info">{{ ui.critNotification.attacker }} ‚öîÔ∏è {{ ui.critNotification.target }}</div>
                <div class="crit-text">{{ ui.critNotification.type === 'success' ? 'Â§ßÊàêÂäü' : 'Â§ßÂ§±Ë¥•' }}</div>
                <button class="btn" @click="dismissCurrentNotification" style="margin-top: 20px;">ÂÖ≥Èó≠</button>
            </div>
        </div>

        <!-- Ê®°ÊÄÅÔºöÊôÆÈÄöÂëΩ‰∏≠ËØ¶ÊÉÖÊèêÁ§∫ -->
        <div v-if="ui.normalHitNotification.open" class="crit-notification-mask">
            <div class="normal-hit-notification-modal">
                <div class="hit-info-header">
                    <span>{{ ui.normalHitNotification.attacker }} ‚öîÔ∏è {{ ui.normalHitNotification.target }}</span>
                    <span class="hit-roll-display">
                        ÂëΩ‰∏≠Ê£ÄÂÆö: {{ ui.normalHitNotification.toHitRoll }} = 
                        <span class="hit-result">{{ ui.normalHitNotification.toHitResult }}</span> vs AC {{ ui.normalHitNotification.targetAC }}
                    </span>
                </div>
                <div class="damage-details">
                    <div class="damage-expression">{{ ui.normalHitNotification.damageExpression }}</div>
                    <div class="damage-calculation">
                        {{ ui.normalHitNotification.damageRolls }} = <span class="raw-damage">{{ ui.normalHitNotification.rawDamage }}</span> {{ ui.normalHitNotification.damageType }}
                    </div>
                </div>
                <div class="final-damage-section">
                    <div class="final-damage-value">
                        {{ ui.normalHitNotification.finalDamage }}
                    </div>
                    <div class="final-damage-label">
                        ÊúÄÁªà‰º§ÂÆ≥ {{ ui.normalHitNotification.damageModifierInfo }}
                    </div>
                </div>
                <button class="btn" @click="dismissCurrentNotification" style="margin-top: 16px;">ÂÖ≥Èó≠</button>
            </div>
        </div>

        <!-- Ê®°ÊÄÅÔºöÂø´Êç∑ÊäïÈ™∞ËæìÂÖ• -->
        <div v-if="ui.quickDice.inputOpen" class="modal-mask" @click.self="ui.quickDice.inputOpen = false">
            <div class="modal" style="max-width: 480px;">
                <form @submit.prevent="executeQuickRoll">
                    <div class="row">
                        <div class="title">Âø´Êç∑ÊäïÈ™∞</div>
                        <div class="spacer"></div>
                        <button class="btn" type="button" @click="ui.quickDice.inputOpen = false">ÂÖ≥Èó≠</button>
                    </div>
                    <div class="hl"></div>
                    <div class="col">
                        <label>ËæìÂÖ•ÊäïÈ™∞Ë°®ËææÂºè (‰æãÂ¶Ç: 1d20+1d4+2)</label>
                        <input ref="quickRollInput" class="input mono" style="margin-top: 8px; font-size: 1.2em;" type="text" v-model="ui.quickDice.expression" placeholder="e.g. 2d8+4">
                    </div>
                    <div class="hl"></div>
                    <div class="row">
                        <div class="spacer"></div>
                        <button class="btn primary" type="submit">ÊäïÈ™∞ (Enter)</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Ê®°ÊÄÅÔºöÂø´Êç∑ÊäïÈ™∞ÁªìÊûú -->
        <div v-if="ui.quickDice.resultOpen" class="modal-mask" @click.self="ui.quickDice.resultOpen = false">
            <div class="modal dice-result-modal" style="max-width: 520px; text-align: center;">
                <div class="row">
                    <div class="title">ÊäïÈ™∞ÁªìÊûú: {{ ui.quickDice.expression }}</div>
                    <div class="spacer"></div>
                    <button class="btn" @click="ui.quickDice.resultOpen = false">ÂÖ≥Èó≠</button>
                </div>
                <div class="hl"></div>
                <div v-if="ui.quickDice.result">
                    <div class="dice-result-breakdown">
                        <template v-for="(group, groupIndex) in ui.quickDice.result.rolls">
                            <span v-for="(roll, rollIndex) in group.results" :key="group.die + rollIndex">
                                {{ group.die }}: <strong>{{ roll }}</strong>
                                <br>
                            </span>
                        </template>
                        <span v-if="ui.quickDice.result.modifier !== 0">
                            Ë∞ÉÊï¥ÂÄº: <strong>{{ ui.quickDice.result.modifier > 0 ? '+' : '' }}{{ ui.quickDice.result.modifier }}</strong>
                        </span>
                    </div>
                    <div class="dice-result-total-label">ÊÄªËÆ°</div>
                    <div class="dice-result-total">{{ ui.quickDice.result.total }}</div>
                </div>
                <div class="hl"></div>
                <div class="row">
                    <div class="spacer"></div>
                    <button class="btn ok" @click="ui.quickDice.resultOpen = false">Â•ΩÁöÑ</button>
                </div>
            </div>
        </div>
        <!-- Ê®°ÊÄÅÔºöÊú™ÂëΩ‰∏≠ÊèêÁ§∫ -->
        <div v-if="ui.missNotification.open" class="crit-notification-mask">
            <div class="miss-notification-modal">
                <div class="hit-info-header">
                    <span>{{ ui.missNotification.attacker }} ‚öîÔ∏è {{ ui.missNotification.target }}</span>
                    <span class="hit-roll-display">
                        ÂëΩ‰∏≠Ê£ÄÂÆö: {{ ui.missNotification.toHitRoll }} = 
                        <span class="hit-result">{{ ui.missNotification.toHitResult }}</span> vs AC {{ ui.missNotification.targetAC }}
                    </span>
                </div>
                <div class="miss-text-section">
                    <div class="miss-text">Êú™ÂëΩ‰∏≠</div>
                </div>
                <button class="btn" @click="dismissCurrentNotification" style="margin-top: 16px;">ÂÖ≥Èó≠</button>
            </div>
        </div>

        <!-- Toast ÊèêÁ§∫ÂÆπÂô® -->
        <transition-group name="toast-fade" tag="div" class="toast-container">
            <div v-for="toast in ui.toasts" :key="toast.id" class="toast-item">
                <span class="toast-message">{{ toast.message }}</span>
                <button class="toast-close" @click="removeToast(toast.id)">&times;</button>
            </div>
        </transition-group>
    </div>
    <script src="app.js"></script>

     <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }
    </script>
</body>
</html>
