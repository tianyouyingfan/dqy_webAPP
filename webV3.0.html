<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <title>DNDæˆ˜æ–—è¾…åŠ©å·¥å…·ï¼ˆæœ¬åœ°ç‰ˆï¼‰V2.0</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- ç¦»çº¿äº¤ä»˜æ—¶è¯·å°†ä»¥ä¸‹ CDN æ”¹ä¸ºæœ¬åœ° vendor/ æ–‡ä»¶ -->
    <script src="vendor/vue.global.prod.min.js"></script>
    <script src="vendor/dexie.min.js"></script>
    <style>
        :root {
            --bg: #0f1012;
            --panel: #15171a;
            --card: #1b1e22;
            --muted: #8b8f96;
            --text: #e8eaed;
            --accent: #d32f2f;
            /* D&D Beyond é£æ ¼çº¢ */
            --accent-2: #ef5350;
            --ok: #29b87e;
            --warn: #ffb300;
            --danger: #ef5350;
            --radius: 12px;
            --shadow: 0 10px 24px rgba(0, 0, 0, .35);
            --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
            --font: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
        }

        * {
            box-sizing: border-box
        }

        html,
        body {
            margin: 0;
            padding: 0;
            background: var(--bg);
            color: var(--text);
            font-family: var(--font);
            font-size: 15px
        }

        a {
            color: var(--accent)
        }

        .app {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        header {
            position: sticky;
            top: 0;
            z-index: 10;
            background: linear-gradient(180deg, rgba(18, 20, 23, .95), rgba(18, 20, 23, .85));
            backdrop-filter: blur(6px);
            border-bottom: 1px solid #23262a;
        }

        .topbar {
            max-width: 1280px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px 16px;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
            letter-spacing: .3px
        }

        .brand .dot {
            width: 10px;
            height: 10px;
            background: var(--accent);
            border-radius: 50%
        }

        .tabs {
            display: flex;
            gap: 6px;
            flex-wrap: wrap
        }

        .tab {
            padding: 8px 12px;
            border-radius: 10px;
            cursor: pointer;
            color: #c9ccd1;
            border: 1px solid transparent;
        }

        .tab.active {
            background: var(--accent);
            color: white;
            border-color: transparent
        }

        .tab:not(.active):hover {
            border-color: #2a2e34;
            background: #1a1d21
        }

        .spacer {
            flex: 1
        }

        .btn {
            border: 1px solid #2a2e34;
            background: #1a1d21;
            color: #dfe3e7;
            border-radius: 10px;
            padding: 8px 12px;
            cursor: pointer;
        }

        .btn.primary {
            background: var(--accent);
            border-color: var(--accent);
            color: #fff
        }

        .btn.ghost {
            background: transparent
        }

        .btn.warn {
            background: var(--warn);
            border-color: var(--warn);
            color: #111
        }

        .btn.ok {
            background: var(--ok);
            border-color: var(--ok);
            color: #111
        }

        .btn.danger {
            background: var(--danger);
            border-color: var(--danger);
            color: #fff
        }

        .btn:disabled {
            opacity: .6;
            cursor: not-allowed
        }

        main {
            max-width: 1280px;
            margin: 0 auto;
            padding: 16px;
            flex: 1;
            width: 100%
        }

        .toolbar {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 12px
        }

        .input,
        select,
        .chip {
            background: #14171a;
            border: 1px solid #2a2e34;
            color: #dfe3e7;
            border-radius: 10px;
            padding: 8px 10px
        }

        .chip {
            display: inline-flex;
            gap: 6px;
            align-items: center;
            cursor: pointer
        }

        .chip.active {
            background: #28313a;
            border-color: #3b4653
        }

        .grid {
            display: grid;
            gap: 12px
        }

        .cards {
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr))
        }

        .card {
            background: var(--card);
            border: 1px solid #2a2e34;
            border-radius: var(--radius);
            padding: 12px;
            box-shadow: var(--shadow)
        }

        .card .title {
            font-weight: 700
        }

        .muted {
            color: var(--muted)
        }

        .kpi {
            display: flex;
            gap: 12px;
            align-items: center
        }

        .kpi .pill {
            border: 1px solid #2a2e34;
            background: #14171a;
            padding: 4px 8px;
            border-radius: 999px
        }

        .section-title {
            font-weight: 700;
            margin: 14px 0 8px 0
        }
        summary.section-title {
            cursor: pointer;
            margin: 0; /* reset margin for summary */
            padding: 6px 0;
        }

        .row {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap
        }

        .col {
            display: flex;
            flex-direction: column;
            gap: 6px
        }

        .two-col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px
        }

        .three-col {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px
        }

        .hl {
            height: 1px;
            background: #2a2e34;
            margin: 12px 0
        }

        .mono {
            font-family: var(--mono)
        }

        .tag {
            display: inline-flex;
            background: #2a2e34;
            color: #cdd1d6;
            padding: 2px 6px;
            border-radius: 6px;
            font-size: 12px
        }

        /* Battle layout */
        .battle {
            display: grid;
            grid-template-rows: 200px 1fr;
            gap: 12px;
            height: calc(100vh - 120px);
        }

        .initiative-bar {
            background: var(--panel);
            border: 1px solid #2a2e34;
            border-radius: var(--radius);
            padding: 10px;
            overflow: auto;
            display: flex;
            gap: 8px;
            align-items: stretch;
        }

        .init-tile {
            display: flex;
            flex-direction: column;
            gap: 6px;
            min-width: 190px;
            background: #1a1d21;
            border: 1px solid #2a2e34;
            border-radius: 12px;
            padding: 8px;
            transition: border-color 0.3s ease-in-out, box-shadow 0.3s ease-in-out; /* Add transition for smooth effect */
        }

        .init-tile.active-turn-highlight {
            border-color: var(--accent); /* Highlight border with accent color */
            box-shadow: 0 0 15px rgba(211, 47, 47, 0.6); /* Add a glow effect */
        }

        .init-header {
            display: flex;
            align-items: center;
            gap: 8px
        }

        .avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #2a2e34;
            display: flex;
            align-items: center;
            justify-content: center
        }

        .hp {
            font-weight: 700
        }

        .statuses {
            display: flex;
            gap: 6px;
            flex-wrap: wrap
        }

        .status {
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 999px;
            background: #28313a;
            border: 1px solid #3b4653
        }

        .battle-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            height: 100%
        }

        .pane {
            background: var(--panel);
            border: 1px solid #2a2e34;
            border-radius: var(--radius);
            padding: 12px;
            overflow: auto
        }

        .actor-header {
            display: flex;
            gap: 12px;
            align-items: center
        }

        .ability-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px
        }

        .ability {
            background: #14171a;
            border: 1px solid #2a2e34;
            border-radius: 8px;
            padding: 8px;
            text-align: center
        }

        .actions-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px
        }

        .target-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 8px
        }

        .target-card {
            padding: 8px;
            border-radius: 10px;
            border: 1px solid #2a2e34;
            background: #14171a
        }

        .target-card.selected {
            outline: 2px solid var(--accent)
        }

        .drag-handle {
            cursor: grab
        }

        .small {
            font-size: 12px
        }

        .right {
            margin-left: auto
        }

        .pill {
            border: 1px solid #2a2e34;
            background: #14171a;
            padding: 4px 8px;
            border-radius: 999px
        }

        .log {
            font-family: var(--mono);
            white-space: pre-wrap;
            background: #0f1113;
            border: 1px dashed #2a2e34;
            border-radius: 8px;
            padding: 8px;
            color: #b6bac0
        }

        .sticky-toolbar {
            position: sticky;
            top: 8px;
            z-index: 5;
            background: linear-gradient(180deg, rgba(21, 23, 26, .98), rgba(21, 23, 26, .9));
            backdrop-filter: blur(6px);
            padding: 8px;
            border-radius: 10px;
            border: 1px solid #2a2e34
        }

        .danger-zone {
            border: 1px dashed #543;
            background: rgba(211, 47, 47, .05);
            padding: 8px;
            border-radius: 8px
        }

        .ok-zone {
            border: 1px dashed #2a5;
            background: rgba(41, 184, 126, .05);
            padding: 8px;
            border-radius: 8px
        }

        .placeholder {
            padding: 12px;
            border: 1px dashed #3a3f46;
            border-radius: 10px;
            background: #14171a;
            color: #9aa0a6
        }

        .modal-mask {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }

.modal {
    background: #15171a;
    border: 1px solid #2a2e34;
    border-radius: 12px;
    box-shadow: var(--shadow);
    padding: 12px;
    max-width: 720px;
    width: 96%;
    z-index: 51;
    max-height: 90vh; /* é™åˆ¶æœ€å¤§é«˜åº¦ä¸ºè§†çª—é«˜åº¦çš„90% */
    overflow-y: auto; /* å½“å†…å®¹è¶…å‡ºæ—¶ï¼Œæ˜¾ç¤ºå‚ç›´æ»šåŠ¨æ¡ */
}

        .hscroll {
            overflow: auto;
            white-space: nowrap
        }
        .underline-input {
            background: transparent;
            border: none;
            border-bottom: 1px solid var(--muted);
            border-radius: 0;
            width: 100%;
            padding: 4px 0;
            color: var(--text);
            font-family: var(--font);
        }
        .underline-input:focus {
            outline: none;
            border-bottom-color: var(--accent);
        }
    </style>
</head>
<body>
    <div id="app" class="app" v-cloak>
        <header>
            <div class="topbar">
                <div class="brand">
                    <div class="dot"></div>
                    <div>DND æˆ˜æ–—è¾…åŠ©å·¥å…· Â· æœ¬åœ°ç‰ˆ V2.0</div>
                </div>
                <nav class="tabs">
                    <div class="tab" :class="{active: route==='monsters'}" @click="route='monsters'">æ€ªç‰©åº“</div>
                    <div class="tab" :class="{active: route==='pcs'}" @click="route='pcs'">PCè§’è‰²åº“</div>
                    <div class="tab" :class="{active: route==='actions'}" @click="route='actions'">åŠ¨ä½œåº“</div>
                    <div class="tab" :class="{active: route==='battle'}" @click="route='battle'">æˆ˜æ–—</div>
                    <div class="tab" :class="{active: route==='settings'}" @click="route='settings'">å¯¼å…¥/å¯¼å‡º</div>
                </nav>
                <div class="spacer"></div>
                <button class="btn" @click="toggleTheme">åˆ‡æ¢ä¸»é¢˜</button>
            </div>
        </header>

        <main>
            <!-- æ€ªç‰©åº“åˆ—è¡¨é¡µ -->
            <section v-if="route==='monsters'">
                <div class="toolbar">
                    <input class="input" style="min-width:240px" v-model="monsterFilters.keyword" placeholder="æŒ‰åç§°æœç´¢..." />
                    <select v-model="monsterFilters.cr" class="input">
                        <option value="">CRï¼ˆå…¨éƒ¨ï¼‰</option>
                        <option v-for="cr in crOptions" :key="cr" :value="cr">{{cr}}</option>
                    </select>
                    <div class="row">
                        <span class="muted small">ç±»å‹ç­›é€‰ï¼š</span>
                        <span v-for="t in monsterTypes" :key="t" class="chip" :class="{active: monsterFilters.types.includes(t)}" @click="toggleTypeFilter(t)">{{ translateType(t) }}</span>
                    </div>
                    <div class="spacer"></div>
                    <button class="btn" @click="openMonsterEditor()">+ æ–°å»ºæ€ªç‰©</button>
                    <button class="btn" @click="openAbilityPool()">èƒ½åŠ›æ± </button>
                    <button class="btn" @click="seedDemo">è½½å…¥æ¼”ç¤ºæ•°æ®</button>
                </div>

                <div class="grid cards">
                    <div class="card" v-for="m in filteredMonsters" :key="m.id">
                        <div class="row">
                            <div class="avatar" title="å›¾åƒå ä½">ğŸ§Ÿ</div>
                            <div class="title">{{m.name}}</div>
                            <span class="pill right mono">CR {{m.cr}}</span>
                        </div>
                        <div class="kpi muted small" style="margin-top:6px">
                            <span class="pill">AC {{m.ac}}</span>
                            <span class="pill">HP {{m.hp?.average ?? m.hp ?? 'â€”'}}</span>
                            <span class="pill">{{(m.type||[]).map(translateType).join(', ') || 'æœªåˆ†ç±»'}}</span>
                            <span class="pill" v-if="m.isCustom">è‡ªå®šä¹‰</span>
                        </div>
                        <div class="hl"></div>
                        <div class="row">
                            <button class="btn" @click="openMonsterEditor(m)">è¯¦æƒ…/ä¼ªç¼–è¾‘</button>
                            <button class="btn" @click="addToBattleFromMonster(m)">åŠ å…¥æˆ˜æ–—</button>
                            <div class="spacer"></div>
                            <button class="btn" @click="duplicateMonster(m)">å¤åˆ¶</button>
                            <button class="btn danger" @click="deleteMonster(m.id)">åˆ é™¤</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- PC è§’è‰²åº“ -->
            <section v-if="route==='pcs'">
                <div class="toolbar">
                    <button class="btn" @click="openPCEditor()">+ æ–°å»ºPC</button>
                </div>
                <div class="grid cards">
                    <div class="card" v-for="pc in pcs" :key="pc.id">
                        <div class="row">
                            <div class="avatar">ğŸ§</div>
                            <div class="title">{{pc.name}}</div>
                            <span class="pill right">AC {{pc.ac}}</span>
                        </div>
                        <div class="kpi muted small" style="margin-top:6px">
                            <span class="pill">HP {{pc.hpCurrent}}/{{pc.hpMax}}</span>
                            <span class="pill">æ• {{mod(pc.abilities.dex)}} åŠ› {{mod(pc.abilities.str)}} ä½“ {{mod(pc.abilities.con)}}</span>
                        </div>
                        <div class="hl"></div>
                        <div class="row">
                            <button class="btn" @click="openPCEditor(pc)">ç¼–è¾‘</button>
                            <button class="btn" @click="addToBattleFromPC(pc)">åŠ å…¥æˆ˜æ–—</button>
                            <div class="spacer"></div>
                            <button class="btn danger" @click="deletePC(pc.id)">åˆ é™¤</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- åŠ¨ä½œåº“ -->
            <section v-if="route==='actions'">
                <div class="toolbar">
                    <button class="btn" @click="openActionEditor()">+ æ–°å»ºåŠ¨ä½œ</button>
                </div>
                <div class="grid cards">
                    <div class="card" v-for="action in actions" :key="action.id">
                        <div class="row">
                            <div class="title">{{action.name}}</div>
                            <span class="pill right">{{action.type}}</span>
                        </div>
                        <div class="kpi muted small" style="margin-top:6px">
                            <span class="pill" v-if="action.attackBonus">æ”»å‡»+{{action.attackBonus}}</span>
                            <span class="pill" v-if="action.damageDice">ä¼¤å®³ {{action.damageDice}} {{action.damageType}}</span>
                            <span class="pill" v-if="action.saveDC">è±å… DC{{action.saveDC}} {{action.saveAbility}}</span>
                        </div>
                        <div class="hl"></div>
                        <div class="row">
                            <button class="btn" @click="openActionEditor(action)">ç¼–è¾‘</button>
                            <div class="spacer"></div>
                            <button class="btn danger" @click="deleteAction(action.id)">åˆ é™¤</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- æˆ˜æ–—ä¸»ç•Œé¢ï¼ˆä¸‰åŒºå¸ƒå±€ï¼‰ -->
            <section v-if="route==='battle'">
                <div class="battle">
                    <!-- é¡¶éƒ¨å…ˆæ”»åºåˆ—æ¡ï¼ˆ20%ï¼‰ -->
                    <div class="initiative-bar hscroll" @dragover.prevent>
                        <div v-for="(p, idx) in battle.participants" :key="p.uid"
                             class="init-tile"
                             :class="{'active-turn-highlight': currentActor && p.uid === currentActor.uid}"
                             draggable="true" @dragstart="onDragStart(idx)" @drop="onDrop(idx)">
                            <div class="init-header">
                                <div class="drag-handle" title="æ‹–æ‹½è°ƒæ•´é¡ºåº">â ¿</div>
                                <div class="avatar">{{p.avatar || 'ğŸ¯'}}</div>
                                <div class="col">
                                    <div style="font-weight:700">{{p.name}}</div>
                                    <div class="small muted">å…ˆæ”» {{p.initiativeRoll ?? 'â€”'}} + {{p.initiativeModifier ?? 'â€”'}}</div>
                                </div>
                                <div class="spacer"></div>
                                <div class="hp">{{p.hpCurrent}}/{{p.hpMax}}</div>
                            </div>
                            <div class="statuses">
                                <span v-for="s in p.statuses" :key="s.id" class="status" :title="s.name + ' å‰©ä½™'+ s.rounds +'å›åˆ'">
                                    {{s.icon || 'â³'}} {{s.name}} ({{s.rounds}})
                                </span>
                            </div>
                            <div class="row">
                                <button class="btn small" @click="setCurrentActor(p.uid)">è®¾ä¸ºå½“å‰</button>
                                <button class="btn small" @click="removeParticipant(p.uid)">ç§»é™¤</button>
                            </div>
                        </div>
                    </div>

                    <!-- ä¸‹æ–¹å·¦å³ä¸¤ä¾§ï¼ˆå„50%ï¼‰ -->
                    <div class="battle-grid">
                        <!-- å·¦ï¼šå½“å‰è¡ŒåŠ¨è€…è¯¦æƒ… -->
                        <div class="pane">
                            <div class="sticky-toolbar row">
                                <button class="btn" @click="promptAddParticipants()">+ æ·»åŠ å•ä½</button>
                                <button class="btn" @click="rollInitiative()">æ·å…ˆæ”»</button>
                                <button class="btn" @click="prevTurn()">ä¸Šä¸€ä¸ª</button>
                                <button class="btn primary" @click="nextTurn()">ä¸‹ä¸€ä¸ª</button>
                                <span class="pill right">å›åˆï¼š{{battle.round}}</span>
                            </div>
                            <template v-if="currentActor">
                                <div class="actor-header">
                                    <div class="avatar" style="width:40px;height:40px;font-size:20px">{{currentActor.avatar || 'ğŸ¯'}}</div>
                                    <div class="col">
                                        <div class="title">{{currentActor.name}}</div>
                                        <div class="muted small">AC {{currentActor.ac}} Â· HP {{currentActor.hpCurrent}}/{{currentActor.hpMax}}</div>
                                    </div>
                                    <div class="spacer"></div>
                                    <div class="row">
                                        <input class="input small mono" style="width:120px" v-model.number="hpDelta" placeholder="+/-HP">
                                        <button class="btn small" @click="applyHPDelta(currentActor, hpDelta)">åº”ç”¨</button>
                                        <button class="btn small" @click="applyHPDelta(currentActor, Math.floor(hpDelta/2))">åŠä¼¤</button>
                                        <button class="btn small" @click="applyHPDelta(currentActor, hpDelta*2)">åŒå€</button>
                                        <button class="btn small ok" @click="applyHPDelta(currentActor, Math.abs(hpDelta))">æ²»ç–—</button>
                                    </div>
                                </div>

                                <div class="hl"></div>
                                <div class="section-title">å…­å¤§å±æ€§</div>
                                <div class="ability-grid">
                                    <div class="ability" v-for="(v,k) in currentActor.abilities" :key="k">
                                        <div class="muted small">{{k.toUpperCase()}}</div>
                                        <div style="font-weight:700">{{v}} ({{mod(v)>=0?'+':''}}{{mod(v)}})</div>
                                    </div>
                                </div>

                                <div class="hl"></div>
                                <div class="section-title">åŠ¨ä½œ/èƒ½åŠ›</div>
                                <div class="actions-list">
                                    <button class="btn" v-for="a in currentActor.actions || []" :key="a.id" @click="selectAction(a)" :disabled="a.cooldown > 0">
                                        {{a.name}}
                                        <span v-if="a.cooldown > 0" class="muted small">(å†·å´ä¸­ {{a.cooldown}})</span>
                                        <span v-else class="muted small">({{a.type}})</span>
                                    </button>
                                    <span class="muted small" v-if="!currentActor.actions?.length">æš‚æ— åŠ¨ä½œï¼ˆTODOï¼šåœ¨æ€ªç‰©/PCç¼–è¾‘å¤„æ·»åŠ åŠ¨ä½œï¼‰</span>
                                </div>

                                <template v-if="ui.selectedAction">
                                    <div class="hl"></div>
                                    <div class="row">
                                        <div class="section-title">è‡ªåŠ¨åŒ–æ”»å‡»æµç¨‹</div>
                                        <span class="pill">æ¨¡å¼</span>
                                        <select class="input" v-model="ui.rollMode">
                                            <option value="normal">æ— </option>
                                            <option value="adv">ä¼˜åŠ¿</option>
                                            <option value="dis">åŠ£åŠ¿</option>
                                        </select>
                                        <span class="pill">è‡ªåŠ¨æ‰£è¡€</span>
                                        <input type="checkbox" v-model="ui.autoApplyDamage">
                                        <div class="spacer"></div>
                                        <button class="btn" @click="runAction()">æ‰§è¡Œ {{ui.selectedAction.name}}</button>
                                        <button class="btn ghost" @click="ui.selectedAction=null">å–æ¶ˆ</button>
                                    </div>
                                    <div class="row small muted">æç¤ºï¼šåœ¨å³ä¾§æˆ˜åœºæ€»è§ˆé¢æ¿ä¸­å¤šé€‰ç›®æ ‡</div>
                                    <div class="hl"></div>
                                    <div class="log" style="min-height:100px">{{ui.log || 'æˆ˜æ–—æ—¥å¿—å°†æ˜¾ç¤ºäºæ­¤'}}</div>
                                </template>

                                <div class="hl"></div>
                                <div class="section-title">çŠ¶æ€ç®¡ç†</div>
                                <div class="row">
                                    <button class="btn" @click="openStatusPicker(currentActor)">+ æ–½åŠ çŠ¶æ€</button>
                                    <div class="spacer"></div>
                                    <span class="muted small">çŠ¶æ€åˆ°æœŸåå°†è‡ªåŠ¨ç§»é™¤ï¼ˆå›åˆå¼€å§‹æ—¶ç»“ç®—ï¼‰</span>
                                </div>
                                <div class="row" style="margin-top:8px;flex-wrap:wrap;gap:8px">
                                    <span v-for="s in currentActor.statuses" :key="s.id" class="status">
                                        {{s.icon || 'â³'}} {{s.name}} ({{s.rounds}})
                                        <button class="btn small ghost" @click="removeStatus(currentActor, s.id)">ç§»é™¤</button>
                                    </span>
                                </div>
                            </template>
                            <div v-else class="placeholder">è¯·é€‰æ‹©æˆ–æ·»åŠ è¡ŒåŠ¨è€…</div>
                        </div>

                        <!-- å³ï¼šæˆ˜åœºæ€»è§ˆ -->
                        <div class="pane">
                            <div class="row">
                                <div class="section-title">æˆ˜åœºæ€»è§ˆ Â· ç›®æ ‡é€‰æ‹©å™¨</div>
                                <div class="spacer"></div>
                                <button class="btn" @click="selectNone()">æ¸…é™¤é€‰æ‹©</button>
                            </div>
                            <div class="hl"></div>
                            <div class="target-grid">
                                <div class="target-card" v-for="g in groupedParticipants" :key="g.groupName">
                                    <div class="row">
                                        <div class="title">{{g.groupName}}</div>
                                        <div class="spacer"></div>
                                        <button class="btn small" @click="toggleSelectGroup(g)">é€‰æ‹©ç»„</button>
                                    </div>
                                    <div class="hl"></div>
                                    <div class="grid" style="grid-template-columns:repeat( auto-fill, minmax(180px, 1fr));gap:6px">
                                        <div v-for="p in g.members" :key="p.uid" class="target-card" :class="{selected: ui.selectedTargets.includes(p.uid)}" @click="toggleTarget(p.uid)">
                                            <div class="row">
                                                <div class="avatar">{{p.avatar || 'ğŸ¯'}}</div>
                                                <div class="col">
                                                    <div style="font-weight:700">{{p.name}}</div>
                                                    <div class="small muted">AC {{p.ac}}</div>
                                                </div>
                                                <div class="spacer"></div>
                                                <div class="hp">{{p.hpCurrent}}/{{p.hpMax}}</div>
                                            </div>
                                            <div class="row small muted" style="margin-top:4px">
                                                <span class="pill">å…ˆæ”» {{p.initiative ?? 'â€”'}}</span>
                                                <span class="pill">{{p.type}}</span>
                                            </div>
                                            <div class="row" style="margin-top:6px">
                                                <input class="input small mono" style="width:90px" v-model.number="p._hpDelta" placeholder="+/-HP">
                                                <button class="btn small" @click.stop="applyHPDelta(p, p._hpDelta)">åº”ç”¨</button>
                                                <button class="btn small" @click.stop="applyHPDelta(p, Math.floor((p._hpDelta||0)/2))">åŠä¼¤</button>
                                                <button class="btn small" @click.stop="applyHPDelta(p, (p._hpDelta||0)*2)">åŒå€</button>
                                                <button class="btn small ok" @click.stop="applyHPDelta(p, Math.abs(p._hpDelta||0))">æ²»ç–—</button>
                                            </div>
                                            <div class="row" style="margin-top:6px">
                                                <button class="btn small" @click.stop="openStatusPicker(p)">+ çŠ¶æ€</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="hl"></div>
                            <div class="danger-zone small">
                                TODOï¼šæˆ˜åœºæ•´ä½“æ ‡è®°/æ‰‹åŠ¨åˆ†ç»„ä¸é‡å‘½åç®¡ç†äº¤äº’å¢å¼ºï¼ˆç›®å‰æŒ‰åŒåè‡ªåŠ¨æˆç»„ï¼Œå¯åœ¨å•ä½è¯¦æƒ…é‡å‘½ååˆ†ç»„ï¼‰
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- å¯¼å…¥/å¯¼å‡º -->
            <section v-if="route==='settings'">
                <div class="card">
                    <div class="section-title">æ•°æ®å¯¼å…¥/å¯¼å‡ºï¼ˆJSONï¼Œå…¨é‡ï¼‰</div>
                    <div class="row">
                        <button class="btn" @click="exportAll()">å¯¼å‡ºå…¨éƒ¨æ•°æ®</button>
                        <input type="file" ref="file" accept="application/json" @change="importAll" hidden>
                        <button class="btn" @click="$refs.file.click()">å¯¼å…¥æ•°æ®</button>
                        <div class="spacer"></div>
                        <span class="muted">æ‰€æœ‰æ•°æ®å‡å­˜å‚¨äºæµè§ˆå™¨ IndexedDBï¼Œæ”¯æŒç¦»çº¿ä½¿ç”¨</span>
                    </div>
                </div>
                <div class="hl"></div>
                <div class="card">
                    <div class="section-title">é¡¹ç›®è¯´æ˜/å ä½</div>
                    <div class="placeholder">
                        - TODOï¼šå®Œæ•´çš„ã€Šæ€ªç‰©å›¾é‰´ã€‹æ ·å¼æ’ç‰ˆï¼ˆæŒ‰å®˜æ–¹é£æ ¼ï¼‰<br>
                        - TODOï¼šCR ä¸€é”®è°ƒæ•´ç®—æ³•ç»†èŠ‚å®Œå–„ä¸â€œä¼¤å®³/è½®â€åç®—ä¼¤å®³éª°<br>
                        - TODOï¼šæ›´ä¸°å¯Œçš„çŠ¶æ€å›¾æ ‡ä¸è¯´æ˜ã€æ‚¬æµ®æç¤º<br>
                    </div>
                </div>
            </section>
        </main>

        <!-- æ¨¡æ€ï¼šæ€ªç‰©ç¼–è¾‘å™¨ -->
        <div class="modal-mask" v-if="ui.monsterEditor.open">
            <div class="modal">
                <div class="row">
                    <div class="title">æ€ªç‰©è¯¦æƒ…/ç¼–è¾‘å™¨</div>
                    <div class="spacer"></div>
                    <button class="btn" @click="ui.monsterEditor.mode = ui.monsterEditor.mode === 'view' ? 'edit' : 'view'">
                        {{ ui.monsterEditor.mode === 'view' ? 'åˆ‡æ¢åˆ°ç¼–è¾‘æ¨¡å¼' : 'åˆ‡æ¢åˆ°æŸ¥çœ‹æ¨¡å¼' }}
                    </button>
                    <button class="btn" @click="ui.monsterEditor.open=false">å…³é—­</button>
                </div>
                <div class="hl"></div>

                <!-- æŸ¥çœ‹æ¨¡å¼ -->
                <div v-if="ui.monsterEditor.mode === 'view'">
                    <div class="placeholder">
                        æ€ªç‰©æ•°æ®åªè¯»è§†å›¾å ä½ç¬¦ã€‚
                        <br>åç§°: {{ uiState.monsterDraft.name }}
                        <br>CR: {{ uiState.monsterDraft.cr }}
                        <br>AC: {{ uiState.monsterDraft.ac }}
                        <br>HP: {{ uiState.monsterDraft.hp.average }}
                        <br>... æ›´å¤šæ•°æ®å¾…å¡«å…… ...
                    </div>
                </div>

                <!-- ç¼–è¾‘æ¨¡å¼ -->
                <div v-if="ui.monsterEditor.mode === 'edit'">
                    <div class="two-col">
                        <div class="col">
                            <label>åç§°</label>
                            <input class="input" v-model="uiState.monsterDraft.name" placeholder="ä¾‹å¦‚ï¼šå“¥å¸ƒæ—" />
                        </div>
                        <div class="col">
                            <label>CR</label>
                            <input type="number" step="0.5" class="input" v-model.number="uiState.monsterDraft.cr" />
                        </div>
                        <div class="col">
                            <label>ç±»å‹ï¼ˆå¤šé€‰é€—å·åˆ†éš”ï¼‰</label>
                            <input class="input" v-model="monsterTypesStr" placeholder="ä¾‹å¦‚ï¼šhumanoid, goblinoid" />
                        </div>
                        <div class="col">
                            <label>AC</label>
                            <input type="number" class="input" v-model.number="uiState.monsterDraft.ac" />
                        </div>
                        <div class="col">
                            <label>HP å¹³å‡</label>
                            <input type="number" class="input" v-model.number="uiState.monsterDraft.hp.average" />
                        </div>
                        <div class="col">
                            <label>é€Ÿåº¦ï¼ˆæ­¥è¡Œï¼‰</label>
                            <input type="number" class="input" v-model.number="uiState.monsterDraft.speed.walk" />
                        </div>
                    </div>

                    <details open>
                        <summary class="section-title">å…­å¤§å±æ€§</summary>
                        <div class="ability-grid" style="padding-top: 8px;">
                            <div class="ability" v-for="k in ['str','dex','con','int','wis','cha']" :key="k">
                                <div class="muted small">{{k.toUpperCase()}}</div>
                                <input type="number" class="input" style="width:80px" v-model.number="uiState.monsterDraft.abilities[k]" />
                            </div>
                        </div>
                    </details>

                    <div class="hl"></div>
                    <details>
                        <summary class="section-title">æŠ—æ€§/æ˜“ä¼¤/å…ç–«ï¼ˆä¼¤å®³/çŠ¶æ€ï¼‰</summary>
                        <div class="three-col" style="padding-top: 8px;">
                            <div class="col">
                                <label>æŠ—æ€§ï¼ˆä¼¤å®³ï¼‰</label>
                                <input class="input" v-model="uiState.monsterDraft.resistances.damageStr" placeholder="cold, fire" />
                            </div>
                            <div class="col">
                                <label>æ˜“ä¼¤ï¼ˆä¼¤å®³ï¼‰</label>
                                <input class="input" v-model="uiState.monsterDraft.vulnerabilities.damageStr" placeholder="radiant" />
                            </div>
                            <div class="col">
                                <label>å…ç–«ï¼ˆä¼¤å®³ï¼‰</label>
                                <input class="input" v-model="uiState.monsterDraft.immunities.damageStr" placeholder="poison" />
                            </div>
                            <div class="col">
                                <label>å…ç–«ï¼ˆçŠ¶æ€ï¼‰</label>
                                <input class="input" v-model="uiState.monsterDraft.immunities.conditionsStr" placeholder="charmed, frightened" />
                            </div>
                        </div>
                    </details>

                    <div class="hl"></div>
                    <details open>
                        <summary class="section-title row">
                            <span>ç‰¹æ®Šèƒ½åŠ›/åŠ¨ä½œ</span>
                            <div class="spacer"></div>
                            <button v-if="uiState.monsterDraft.actions.length > 2" class="btn small" @click.prevent="openActionsViewer(uiState.monsterDraft, 'monster')">
                                æŸ¥çœ‹å…¨éƒ¨ ({{ uiState.monsterDraft.actions.length }})
                            </button>
                            <button class="btn small" @click.prevent="openActionPool()">ä»åŠ¨ä½œåº“æ·»åŠ </button>
                            <button class="btn small" @click.prevent="openAbilityPool()">ä»èƒ½åŠ›æ± æ·»åŠ </button>
                        </summary>
                        <div class="grid" style="padding-top: 8px;" v-if="uiState.monsterDraft.actions.length <= 2">
                                <div class="card" v-for="(a, idx) in uiState.monsterDraft.actions" :key="idx">
                                <div class="row">
                                    <input class="input" style="min-width:160px" v-model="a.name" placeholder="åŠ¨ä½œåç§°" />
                                    <select class="input" v-model="a.type">
                                        <option value="attack">æ”»å‡»æ£€å®š</option>
                                        <option value="save">è±å…æ£€å®š</option>
                                        <option value="utility">å…¶ä»–</option>
                                    </select>
                                    <span class="pill">å……èƒ½</span>
                                    <input type="number" class="input" style="width:80px" v-model.number="a.recharge" placeholder="0" />
                                    <div class="spacer"></div>
                                    <button class="btn danger" @click="uiState.monsterDraft.actions.splice(idx,1)">åˆ é™¤</button>
                                </div>
                                <div class="row small">
                                    <template v-if="a.type==='attack'">
                                        <span class="pill">æ”»å‡»åŠ å€¼</span>
                                        <input type="number" class="input" style="width:90px" v-model.number="a.attackBonus" />
                                        <span class="pill">ä¼¤å®³</span>
                                        <input class="input mono" style="width:120px" v-model="a.damageDice" placeholder="ä¾‹å¦‚ 2d6+3" />
                                        <select class="input" v-model="a.damageType">
                                            <option v-for="dt in damageTypes" :key="dt" :value="dt">{{dt}}</option>
                                        </select>
                                    </template>
                                    <template v-else-if="a.type==='save'">
                                        <span class="pill">è±å…å±æ€§</span>
                                        <select class="input" v-model="a.saveAbility">
                                            <option>str</option>
                                            <option>dex</option>
                                            <option>con</option>
                                            <option>int</option>
                                            <option>wis</option>
                                            <option>cha</option>
                                        </select>
                                        <span class="pill">DC</span>
                                        <input type="number" class="input" style="width:90px" v-model.number="a.saveDC" />
                                        <span class="pill">ä¼¤å®³</span>
                                        <input class="input mono" style="width:120px" v-model="a.damageDice" placeholder="2d6+3" />
                                        <select class="input" v-model="a.damageType">
                                            <option v-for="dt in damageTypes" :key="dt" :value="dt">{{dt}}</option>
                                        </select>
                                        <span class="pill">æˆåŠŸæ˜¯å¦åŠä¼¤</span>
                                        <select class="input" v-model="a.onSuccess">
                                            <option value="half">åŠä¼¤</option>
                                            <option value="none">å…ç–«</option>
                                        </select>
                                    </template>
                                    <template v-else>
                                        <span class="muted">å®ç”¨åŠ¨ä½œï¼Œæ— è‡ªåŠ¨ç»“ç®—</span>
                                    </template>
                                </div>
                            </div>
                        </div>
                        <button class="btn" @click="uiState.monsterDraft.actions.push({name:'æ–°åŠ¨ä½œ', type:'attack', attackBonus:0, damageDice:'1d6', damageType:'æ–©å‡»', recharge: 0})" style="margin-top: 8px;" v-if="uiState.monsterDraft.actions.length <= 2">+ æ·»åŠ åŠ¨ä½œ</button>
                    </details>

                    <div class="hl"></div>
                    <details>
                        <summary class="section-title">CR ä¸€é”®è°ƒæ•´</summary>
                        <div class="row" style="padding-top: 8px;">
                            <input type="number" step="0.5" class="input" style="width:120px" v-model.number="uiState.targetCR" placeholder="ç›®æ ‡CR">
                            <button class="btn" @click="autoAdjustCR()">è°ƒæ•´</button>
                        </div>
                        <div class="danger-zone small" style="margin-top: 8px;">
                            TODOï¼šå®Œå–„â€œæ™ºèƒ½CRè°ƒæ•´ç®—æ³•â€æ˜ å°„è§„åˆ™ä¸èŒƒå›´å€¼éšæœºç”Ÿæˆã€æ ¹æ®ä¼¤å®³/è½®åç®—ä¼¤å®³éª°ã€‚ç›®å‰ä¸ºå ä½ç®€åŒ–å®ç°ï¼Œä¾¿äºåç»­æ›¿æ¢ã€‚
                        </div>
                    </details>
                </div>

                <div class="hl"></div>
                <div class="row">
                    <button class="btn ok" @click="saveMonsterAsCustom()">ä¿å­˜å¹¶å…³é—­</button>
                    <div class="spacer"></div>
                    <button class="btn" @click="addToBattleFromEditor(uiState.monsterDraft, 'monster')">åŠ å…¥æˆ˜æ–—å¹¶å…³é—­</button>
                </div>
            </div>
        </div>

        <!-- æ¨¡æ€ï¼šèƒ½åŠ›æ±  -->
        <div class="modal-mask" v-if="ui.abilityPool.open" :style="{ zIndex: ui.abilityPool.nested ? 60 : 50 }">
            <div class="modal">
                <div class="row">
                    <div class="title">ç‰¹æ®Šèƒ½åŠ›åº“</div>
                    <div class="spacer"></div>
                    <button class="btn" @click="ui.abilityPool.open=false">å…³é—­</button>
                </div>
                <div class="hl"></div>
                <div class="toolbar">
                    <input class="input" placeholder="æœç´¢èƒ½åŠ›..." v-model="ui.abilityPool.keyword" />
                    <button class="btn" @click="openAbilityEditor()">+ æ–°èƒ½åŠ›</button>
                </div>
                <div class="grid cards">
                    <div class="card" v-for="ab in filteredAbilities" :key="ab.id">
                        <div class="row">
                            <div class="title">{{ab.name}}</div>
                            <div class="spacer"></div>
                            <button class="btn" @click="attachAbilityToDraft(ab)">æ·»åŠ åˆ°å½“å‰æ€ªç‰©</button>
                            <button class="btn" @click="openAbilityEditor(ab)">ç¼–è¾‘</button>
                            <button class="btn danger" @click="deleteAbility(ab.id)">åˆ é™¤</button>
                        </div>
                        <div class="muted small" style="margin-top:6px">{{ab.description}}</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ¨¡æ€ï¼šåŠ¨ä½œåº“ -->
        <div class="modal-mask" v-if="ui.actionPool.open" :style="{ zIndex: ui.actionPool.nested ? 60 : 50 }">
            <div class="modal">
                <div class="row">
                    <div class="title">åŠ¨ä½œåº“</div>
                    <div class="spacer"></div>
                    <button class="btn" @click="ui.actionPool.open=false">å…³é—­</button>
                </div>
                <div class="hl"></div>
                <div class="toolbar">
                    <input class="input" placeholder="æœç´¢åŠ¨ä½œ..." v-model="ui.actionPool.keyword" />
                    <button class="btn" @click="openActionEditor()">+ æ–°åŠ¨ä½œ</button>
                </div>
                <div class="grid cards">
                    <div class="card" v-for="action in filteredActions" :key="action.id">
                        <div class="row">
                            <div class="title">{{action.name}}</div>
                            <span class="pill right">{{action.type}}</span>
                        </div>
                        <div class="kpi muted small" style="margin-top:6px">
                            <span class="pill" v-if="action.attackBonus">æ”»å‡»+{{action.attackBonus}}</span>
                            <span class="pill" v-if="action.damageDice">ä¼¤å®³ {{action.damageDice}} {{action.damageType}}</span>
                            <span class="pill" v-if="action.saveDC">è±å… DC{{action.saveDC}} {{action.saveAbility}}</span>
                        </div>
                        <div class="hl"></div>
                        <div class="row">
                            <button class="btn" @click="attachActionToDraft(action)">æ·»åŠ åˆ°å½“å‰ç”Ÿç‰©</button>
                            <button class="btn" @click="openActionEditor(action)">ç¼–è¾‘</button>
                            <button class="btn danger" @click="deleteAction(action.id)">åˆ é™¤</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ¨¡æ€ï¼šèƒ½åŠ›ç¼–è¾‘ -->
        <div class="modal-mask" v-if="ui.abilityEditor.open">
            <div class="modal">
                <div class="row">
                    <div class="title">ç¼–è¾‘èƒ½åŠ›</div>
                    <div class="spacer"></div>
                    <button class="btn" @click="ui.abilityEditor.open=false">å…³é—­</button>
                </div>
                <div class="hl"></div>
                <div class="col">
                    <label>åç§°</label>
                    <input class="input" v-model="uiState.abilityDraft.name" />
                    <label>æè¿°</label>
                    <textarea class="input" rows="4" v-model="uiState.abilityDraft.description" placeholder="èƒ½åŠ›è¯´æ˜..."></textarea>
                    <div class="hl"></div>
                    <button class="btn ok" @click="saveAbility()">ä¿å­˜å¹¶å…³é—­</button>
                </div>
            </div>
        </div>

        <!-- æ¨¡æ€ï¼šPC ç¼–è¾‘ -->
        <div class="modal-mask" v-if="ui.pcEditor.open">
            <div class="modal">
                <div class="row">
                    <div class="title">PC è§’è‰²ç¼–è¾‘</div>
                    <div class="spacer"></div>
                    <button class="btn" @click="ui.pcEditor.open=false">å…³é—­</button>
                </div>
                <div class="hl"></div>
                <div class="two-col">
                    <div class="col"><label>åç§°</label><input class="input" v-model="uiState.pcDraft.name" /></div>
                    <div class="col"><label>AC</label><input type="number" class="input" v-model.number="uiState.pcDraft.ac" /></div>
                    <div class="col"><label>HP æœ€å¤§</label><input type="number" class="input" v-model.number="uiState.pcDraft.hpMax" /></div>
                    <div class="col"><label>HP å½“å‰</label><input type="number" class="input" v-model.number="uiState.pcDraft.hpCurrent" /></div>
                </div>
                <div class="section-title">å…­å¤§å±æ€§</div>
                <div class="ability-grid">
                    <div class="ability" v-for="k in ['str','dex','con','int','wis','cha']" :key="k">
                        <div class="muted small">{{k.toUpperCase()}}</div>
                        <input type="number" class="input" style="width:80px" v-model.number="uiState.pcDraft.abilities[k]" />
                    </div>
                </div>
                <div class="section-title row">
                    <span>ç‰¹æ€§</span>
                </div>
                <textarea class="input underline-input" rows="3" v-model="uiState.pcDraft.features" placeholder="è¾“å…¥è§’è‰²çš„ç‰¹æ€§ã€èƒŒæ™¯ã€å…³é”®ä¿¡æ¯ç­‰..."></textarea>

                <div class="section-title row">
                    <span>åŠ¨ä½œ</span>
                    <div class="spacer"></div>
                    <button v-if="uiState.pcDraft.actions.length > 2" class="btn small" @click.prevent="openActionsViewer(uiState.pcDraft, 'pc')">
                        æŸ¥çœ‹å…¨éƒ¨ ({{ uiState.pcDraft.actions.length }})
                    </button>
                    <button class="btn small" @click.prevent="openActionPool()">ä»åŠ¨ä½œåº“æ·»åŠ </button>
                </div>
                <div class="grid" style="padding-top: 8px;" v-if="uiState.pcDraft.actions.length <= 2">
                    <div class="card" v-for="(a, idx) in uiState.pcDraft.actions" :key="idx">
                        <div class="row">
                            <div class="title">{{a.name}}</div>
                            <span class="pill right">{{a.type}}</span>
                            <div class="spacer"></div>
                            <button class="btn danger" @click="uiState.pcDraft.actions.splice(idx,1)">åˆ é™¤</button>
                        </div>
                        <div class="kpi muted small" style="margin-top:6px">
                            <span class="pill" v-if="a.attackBonus">æ”»å‡»+{{a.attackBonus}}</span>
                            <span class="pill" v-if="a.damageDice">ä¼¤å®³ {{a.damageDice}} {{a.damageType}}</span>
                            <span class="pill" v-if="a.saveDC">è±å… DC{{a.saveDC}} {{a.saveAbility}}</span>
                        </div>
                    </div>
                    <div v-if="!uiState.pcDraft.actions?.length" class="placeholder small">è¯¥è§’è‰²æš‚æ— åŠ¨ä½œ</div>
                </div>

                <div class="hl"></div>
                <div class="row">
                    <button class="btn ok" @click="savePC()">ä¿å­˜å¹¶å…³é—­</button>
                    <div class="spacer"></div>
                    <button class="btn" @click="addToBattleFromEditor(uiState.pcDraft, 'pc')">åŠ å…¥æˆ˜æ–—å¹¶å…³é—­</button>
                </div>
            </div>
        </div>

        <!-- æ¨¡æ€ï¼šåŠ¨ä½œç¼–è¾‘ -->
        <div class="modal-mask" v-if="ui.actionEditor.open">
            <div class="modal">
                <div class="row">
                    <div class="title">ç¼–è¾‘åŠ¨ä½œ</div>
                    <div class="spacer"></div>
                    <button class="btn" @click="ui.actionEditor.open=false">å…³é—­</button>
                </div>
                <div class="hl"></div>
                <div class="col">
                    <div class="row">
                        <div class="col">
                            <label>åŠ¨ä½œåç§°</label>
                            <input class="input" style="min-width:160px" v-model="uiState.actionDraft.name" placeholder="åŠ¨ä½œåç§°" />
                        </div>
                        <div class="col">
                            <label>ç±»å‹</label>
                            <select class="input" v-model="uiState.actionDraft.type">
                                <option value="attack">æ”»å‡»æ£€å®š</option>
                                <option value="save">è±å…æ£€å®š</option>
                                <option value="utility">å…¶ä»–</option>
                            </select>
                        </div>
                    </div>
                    <div class="hl"></div>
                    <div class="row small" style="gap:12px">
                        <template v-if="uiState.actionDraft.type==='attack'">
                            <div class="col">
                                <label>æ”»å‡»åŠ å€¼</label>
                                <input type="number" class="input" style="width:90px" v-model.number="uiState.actionDraft.attackBonus" />
                            </div>
                            <div class="col">
                                <label>ä¼¤å®³éª°</label>
                                <input class="input mono" style="width:120px" v-model="uiState.actionDraft.damageDice" placeholder="ä¾‹å¦‚ 2d6+3" />
                            </div>
                             <div class="col">
                                <label>ä¼¤å®³ç±»å‹</label>
                                <select class="input" v-model="uiState.actionDraft.damageType">
                                    <option v-for="dt in damageTypes" :key="dt" :value="dt">{{dt}}</option>
                                </select>
                            </div>
                            <div class="col">
                                <label>å……èƒ½å›åˆ</label>
                                <input type="number" class="input" style="width:90px" v-model.number="uiState.actionDraft.recharge" placeholder="0" />
                            </div>
                            <div class="col">
                                <label>å‘½ä¸­é™„åŠ çŠ¶æ€</label>
                                <select class="input" v-model="uiState.actionDraft.onHitStatus">
                                    <option value="">æ— </option>
                                    <option v-for="s in statusCatalog" :key="s.name" :value="s.name">{{s.name}}</option>
                                </select>
                                <div v-if="uiState.actionDraft.onHitStatus" class="form-row">
                                  <label>
                                    è±å…å±æ€§:
                                    <select v-model="uiState.actionDraft.onHitSaveAbility">
                                      <option value="str">åŠ›é‡ (Strength)</option>
                                      <option value="dex">æ•æ· (Dexterity)</option>
                                      <option value="con">ä½“è´¨ (Constitution)</option>
                                      <option value="int">æ™ºåŠ› (Intelligence)</option>
                                      <option value="wis">æ„ŸçŸ¥ (Wisdom)</option>
                                      <option value="cha">é­…åŠ› (Charisma)</option>
                                    </select>
                                  </label>
                                  <label>
                                    è±å…DC:
                                    <input type="number" v-model.number="uiState.actionDraft.onHitSaveDC" style="width: 60px;">
                                  </label>
                                </div>
                            </div>
                            <div class="col" v-if="uiState.actionDraft.onHitStatus">
                                <label>çŠ¶æ€æŒç»­å›åˆ</label>
                                <input type="number" class="input" style="width:90px" v-model.number="uiState.actionDraft.onHitStatusRounds" placeholder="é»˜è®¤1" />
                            </div>
                        </template>
                        <template v-else-if="uiState.actionDraft.type==='save'">
                            <div class="col">
                                <label>è±å…å±æ€§</label>
                                <select class="input" v-model="uiState.actionDraft.saveAbility">
                                    <option>str</option>
                                    <option>dex</option>
                                    <option>con</option>
                                    <option>int</option>
                                    <option>wis</option>
                                    <option>cha</option>
                                </select>
                            </div>
                            <div class="col">
                                <label>DC</label>
                                <input type="number" class="input" style="width:90px" v-model.number="uiState.actionDraft.saveDC" />
                            </div>
                            <div class="col">
                                <label>ä¼¤å®³éª°</label>
                                <input class="input mono" style="width:120px" v-model="uiState.actionDraft.damageDice" placeholder="2d6+3" />
                            </div>
                            <div class="col">
                                <label>ä¼¤å®³ç±»å‹</label>
                                <select class="input" v-model="uiState.actionDraft.damageType">
                                    <option v-for="dt in damageTypes" :key="dt" :value="dt">{{dt}}</option>
                                </select>
                            </div>
                            <div class="col">
                                <label>å……èƒ½å›åˆ</label>
                                <input type="number" class="input" style="width:90px" v-model.number="uiState.actionDraft.recharge" placeholder="0" />
                            </div>
                            <div class="col">
                                <label>æˆåŠŸæ˜¯å¦åŠä¼¤</label>
                                <select class="input" v-model="uiState.actionDraft.onSuccess">
                                    <option value="half">åŠä¼¤</option>
                                    <option value="none">å…ç–«</option>
                                </select>
                            </div>
                        </template>
                        <template v-else>
                            <span class="muted">å®ç”¨åŠ¨ä½œï¼Œæ— è‡ªåŠ¨ç»“ç®—</span>
                        </template>
                    </div>
                    <div class="hl"></div>
                    <button class="btn ok" @click="saveAction()">ä¿å­˜å¹¶å…³é—­</button>
                </div>
            </div>
        </div>

        <!-- æ¨¡æ€ï¼šçŠ¶æ€é€‰æ‹©å™¨ -->
        <div class="modal-mask" v-if="ui.statusPicker.open">
            <div class="modal">
                <div class="row">
                    <div class="title">æ–½åŠ çŠ¶æ€</div>
                    <div class="spacer"></div>
                    <button class="btn" @click="ui.statusPicker.open=false">å…³é—­</button>
                </div>
                <div class="hl"></div>
                <div class="row">
                    <select class="input" v-model="ui.statusPicker.selectedName">
                        <option v-for="s in statusCatalog" :key="s.name" :value="s.name">{{s.name}}</option>
                    </select>
                    <input type="number" class="input" style="width:120px" v-model.number="ui.statusPicker.rounds" placeholder="æŒç»­å›åˆæ•°">
                    <input class="input" style="width:120px" v-model="ui.statusPicker.icon" placeholder="å›¾æ ‡(emoji å¯)">
                    <button class="btn ok" @click="applyStatus()">åº”ç”¨</button>
                </div>
                <div class="ok-zone small" style="margin-top:8px">
                    å·²æ”¯æŒè‡ªåŠ¨è¿½è¸ªçŠ¶æ€æ—¶é•¿ï¼Œæ¯åˆ°å›åˆå¼€å§‹è‡ªåŠ¨ -1ï¼Œè‡³ 0 è‡ªåŠ¨ç§»é™¤ã€‚ä¹Ÿå¯æ‰‹åŠ¨ç§»é™¤æˆ–è°ƒæ•´ã€‚
                </div>
            </div>
        </div>

        <!-- æ¨¡æ€ï¼šæ·»åŠ å‚æˆ˜å•ä½ -->
        <div class="modal-mask" v-if="ui.addParticipants.open">
            <div class="modal">
                <div class="row">
                    <div class="title">æ·»åŠ å‚æˆ˜å•ä½</div>
                    <div class="spacer"></div>
                    <button class="btn" @click="ui.addParticipants.open=false">å…³é—­</button>
                </div>
                <div class="hl"></div>
                <div class="two-col">
                    <div>
                        <div class="section-title">ä»æ€ªç‰©åº“æ·»åŠ </div>
                        <input class="input" placeholder="æœç´¢æ€ªç‰©..." v-model="ui.addParticipants.keywordM" />
                        <div class="grid" style="margin-top:8px;max-height:260px;overflow:auto">
                            <div class="row" v-for="m in monsters.filter(x=>!ui.addParticipants.keywordM || x.name.includes(ui.addParticipants.keywordM))" :key="m.id">
                                <span>{{m.name}} <span class="muted small">CR {{m.cr}}</span></span>
                                <div class="spacer"></div>
                                <input type="number" class="input small" style="width:90px" v-model.number="m._addCount" placeholder="æ•°é‡">
                                <button class="btn small" @click="addParticipantsFromMonster(m, m._addCount||1)">æ·»åŠ </button>
                            </div>
                        </div>
                    </div>
                    <div>
                        <div class="section-title">ä»PCåº“æ·»åŠ </div>
                        <input class="input" placeholder="æœç´¢PC..." v-model="ui.addParticipants.keywordP" />
                        <div class="grid" style="margin-top:8px;max-height:260px;overflow:auto">
                            <div class="row" v-for="pc in pcs.filter(x=>!ui.addParticipants.keywordP || x.name.includes(ui.addParticipants.keywordP))" :key="pc.id">
                                <span>{{pc.name}}</span>
                                <div class="spacer"></div>
                                <button class="btn small" @click="addParticipantsFromPC(pc)">æ·»åŠ </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="hl"></div>
                <div class="ok-zone small">æç¤ºï¼šåŒåæ€ªç‰©ä¼šè‡ªåŠ¨åˆ†ç»„ã€‚ä½ ä¹Ÿå¯ä»¥åœ¨å•ä½ä¸Šæ‰‹åŠ¨è®¾å®š groupNameã€‚</div>
            </div>
        </div>

        <!-- æ¨¡æ€ï¼šè±å…æ£€å®š -->
        <div v-if="ui.saveCheck.open" class="modal-mask">
          <div class="modal-wrapper">
            <div class="modal-container">
              <div class="modal-header">
                <h3>è±å…æ£€å®š</h3>
              </div>
              <div class="modal-body">
                <p>ç›®æ ‡ <strong>{{ ui.saveCheck.targetName }}</strong> éœ€è¦è¿›è¡Œä¸€æ¬¡ <strong>DC {{ ui.saveCheck.dc }}</strong> çš„ <strong>{{ ui.saveCheck.ability.toUpperCase() }}</strong> è±å…æ£€å®šã€‚</p>
                <p>è¯·æŠ•æ·d20å¹¶åŠ ä¸Šç›®æ ‡çš„è±å…è°ƒæ•´å€¼ã€‚</p>
              </div>
              <div class="modal-footer">
                <button class="modal-default-button" @click="() => { ui.saveCheck.callback(true); ui.saveCheck.open = false; }">
                  è±å…æˆåŠŸ
                </button>
                <button class="modal-default-button" @click="() => { ui.saveCheck.callback(false); ui.saveCheck.open = false; }">
                  è±å…å¤±è´¥
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- æ¨¡æ€ï¼šåŠ¨ä½œç®¡ç† -->
        <div class="modal-mask" v-if="ui.actionsViewer.open" style="z-index: 55;">
            <div class="modal">
                <div class="row">
                    <div class="title">{{ ui.actionsViewer.title }}</div>
                    <div class="spacer"></div>
                </div>
                <div class="hl"></div>
                <div class="pane" style="max-height: 60vh; overflow-y: auto; background: var(--bg); padding: 8px;">
                    <div class="grid cards">
                        <div class="card" v-for="(a, idx) in ui.actionsViewer.draft.actions" :key="idx">
                            <div class="row">
                                <div class="title">{{a.name}}</div>
                                <span class="pill right">{{a.type}}</span>
                                <div class="spacer"></div>
                                <button class="btn danger" @click="ui.actionsViewer.draft.actions.splice(idx,1)">åˆ é™¤</button>
                            </div>
                            <div class="kpi muted small" style="margin-top:6px">
                                <span class="pill" v-if="a.attackBonus">æ”»å‡»+{{a.attackBonus}}</span>
                                <span class="pill" v-if="a.damageDice">ä¼¤å®³ {{a.damageDice}} {{a.damageType}}</span>
                                <span class="pill" v-if="a.saveDC">è±å… DC{{a.saveDC}} {{a.saveAbility}}</span>
                            </div>
                        </div>
                        <div v-if="!ui.actionsViewer.draft.actions?.length" class="placeholder small">æš‚æ— åŠ¨ä½œ</div>
                    </div>
                </div>
                <div class="hl"></div>
                <div class="row">
                    <button class="btn" @click="openActionPool()">ä»åŠ¨ä½œåº“æ·»åŠ </button>
                    <button class="btn" @click="openAbilityPool()">ä»èƒ½åŠ›æ± æ·»åŠ </button>
                    <div class="spacer"></div>
                    <button class="btn ok" @click="ui.actionsViewer.open = false">å®Œæˆå¹¶å…³é—­</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        const {
            createApp,
            reactive,
            ref,
            computed,
            watch
        } = Vue;

        // Dexie åˆå§‹åŒ–
        const db = new Dexie('dnd-assist-v2');
        db.version(2).stores({
            monsters: '++id, name, cr, isCustom',
            abilities: '++id, name',
            pcs: '++id, name',
            actions: '++id, name, type, onHitStatus, onHitStatusRounds, onHitSaveAbility, onHitSaveDC',
        });

        async function seedIfEmpty() {
            const count = await db.monsters.count();
            if (count > 0) return;
            await db.abilities.bulkAdd([{
                name: 'å†ç”Ÿ',
                description: 'æ¯å›åˆå¼€å§‹æ—¶å›å¤è‹¥å¹²ç”Ÿå‘½å€¼ã€‚'
            }, {
                name: 'æ•æ·é—ªé¿',
                description: 'åœ¨å¯è§æ¥æºçš„èŒƒå›´æ•ˆæœä¼¤å®³ä¸Šæ·æˆåŠŸæ—¶ä¸å—ä¼¤ï¼Œå¤±è´¥æ—¶åªå—åŠä¼¤ã€‚'
            }, ]);
            const actionCount = await db.actions.count();
            if (actionCount === 0) {
                await db.actions.bulkAdd([
                    { name: 'å¼¯åˆ€ (attack)', type: 'attack', attackBonus: 4, damageDice: '1d6+2', damageType: 'æ–©å‡»' },
                    { name: 'çŸ­å¼“ (attack)', type: 'attack', attackBonus: 4, damageDice: '1d6+2', damageType: 'ç©¿åˆº' },
                ]);
            }
            await db.monsters.bulkAdd([{
                name: 'å“¥å¸ƒæ—',
                cr: 0.25,
                type: ['humanoid', 'goblinoid'],
                ac: 15,
                hp: {
                    average: 7,
                    roll: '2d6'
                },
                speed: {
                    walk: 30
                },
                abilities: {
                    str: 8,
                    dex: 14,
                    con: 10,
                    int: 10,
                    wis: 8,
                    cha: 8
                },
                resistances: {
                    damage: [],
                    conditions: []
                },
                vulnerabilities: {
                    damage: [],
                    conditions: []
                },
                immunities: {
                    damage: [],
                    conditions: []
                },
                actions: [{
                    id: crypto.randomUUID(),
                    name: 'å¼¯åˆ€',
                    type: 'attack',
                    attackBonus: 4,
                    damageDice: '1d6+2',
                    damageType: 'æ–©å‡»'
                }, {
                    id: crypto.randomUUID(),
                    name: 'çŸ­å¼“',
                    type: 'attack',
                    attackBonus: 4,
                    damageDice: '1d6+2',
                    damageType: 'ç©¿åˆº'
                }, ],
                isCustom: false
            }, {
                name: 'é£Ÿäººé­”',
                cr: 2,
                type: ['giant'],
                ac: 11,
                hp: {
                    average: 59,
                    roll: '7d10+21'
                },
                speed: {
                    walk: 40
                },
                abilities: {
                    str: 19,
                    dex: 8,
                    con: 16,
                    int: 5,
                    wis: 7,
                    cha: 7
                },
                resistances: {
                    damage: [],
                    conditions: []
                },
                vulnerabilities: {
                    damage: [],
                    conditions: []
                },
                immunities: {
                    damage: [],
                    conditions: []
                },
                actions: [{
                    id: crypto.randomUUID(),
                    name: 'å·¨æ£',
                    type: 'attack',
                    attackBonus: 6,
                    damageDice: '2d8+4',
                    damageType: 'é’å‡»'
                }, {
                    id: crypto.randomUUID(),
                    name: 'æ ‡æª',
                    type: 'attack',
                    attackBonus: 6,
                    damageDice: '2d6+4',
                    damageType: 'ç©¿åˆº'
                }, ],
                isCustom: false
            }, {
                name: 'æˆå¹´çº¢é¾™',
                cr: 17,
                type: ['dragon'],
                ac: 19,
                hp: {
                    average: 256,
                    roll: '19d12+133'
                },
                speed: {
                    walk: 40,
                    fly: 80
                },
                abilities: {
                    str: 27,
                    dex: 10,
                    con: 25,
                    int: 16,
                    wis: 13,
                    cha: 21
                },
                resistances: {
                    damage: [],
                    conditions: []
                },
                vulnerabilities: {
                    damage: [],
                    conditions: []
                },
                immunities: {
                    damage: ['fire'],
                    conditions: []
                },
                actions: [{
                    id: crypto.randomUUID(),
                    name: 'å’¬å‡»',
                    type: 'attack',
                    attackBonus: 14,
                    damageDice: '2d10+8',
                    damageType: 'ç©¿åˆº'
                }, {
                    id: crypto.randomUUID(),
                    name: 'åæ¯æ­¦å™¨',
                    type: 'save',
                    saveAbility: 'dex',
                    saveDC: 21,
                    damageDice: '18d6',
                    damageType: 'ç«ç„°',
                    onSuccess: 'half',
                    recharge: 6,
                }, ],
                isCustom: false
            }]);
            await db.pcs.bulkAdd([{
                name: 'è‰¾ç‘å…‹',
                ac: 16,
                hpMax: 32,
                hpCurrent: 32,
                abilities: {
                    str: 16,
                    dex: 12,
                    con: 14,
                    int: 10,
                    wis: 10,
                    cha: 12
                },
                actions: [],
                features: 'ä¸€åç»éªŒä¸°å¯Œçš„æˆ˜å£«ï¼Œå¿ è¯šå¯é ã€‚'
            }, {
                name: 'ç³',
                ac: 14,
                hpMax: 24,
                hpCurrent: 24,
                abilities: {
                    str: 8,
                    dex: 16,
                    con: 12,
                    int: 14,
                    wis: 12,
                    cha: 10
                },
                actions: [],
                features: 'ä¸€ä½æ•æ·çš„æ¸¸ä¾ ï¼Œæ“…é•¿å¼“ç®­å’Œé‡å¤–ç”Ÿå­˜ã€‚'
            }, ]);
        }

        function deepClone(obj) {
            return JSON.parse(JSON.stringify(obj));
        }
        // å·¥å…·å‡½æ•°
        function abilityMod(score) {
            return Math.floor((score - 10) / 2);
        }

        function rollD20(mode = 'normal') {
            const r1 = Math.floor(Math.random() * 20) + 1;
            if (mode === 'normal') return {
                value: r1,
                isCrit: r1 === 20,
                isFumble: r1 === 1,
                raw: [r1]
            };
            const r2 = Math.floor(Math.random() * 20) + 1;
            const pick = mode === 'adv' ? Math.max(r1, r2) : Math.min(r1, r2);
            return {
                value: pick,
                isCrit: pick === 20,
                isFumble: pick === 1,
                raw: [r1, r2]
            };
        }

        function parseDiceExpr(expr) {
            if (!expr) return { dice: [], flat: 0 };
            const dice = [];
            let flat = 0;
            const parts = expr.replace(/-/g, '+-').split('+');
            for (const part of parts) {
                const trimmed = part.trim();
                if (trimmed.includes('d')) {
                    dice.push(trimmed);
                } else if (trimmed) {
                    flat += parseInt(trimmed, 10) || 0;
                }
            }
            return { dice, flat };
        }

        function rollDamage(expr, isCrit = false, damageType = 'generic') {
            if (!expr) return [{ amount: 0, type: damageType }];
            
            const { dice, flat } = parseDiceExpr(expr);
            let total = flat;

            for (const d of dice) {
                const [countStr, facesStr] = d.toLowerCase().split('d');
                const count = isCrit ? (parseInt(countStr, 10) || 1) * 2 : (parseInt(countStr, 10) || 1);
                const faces = parseInt(facesStr, 10);
                if (isNaN(faces)) continue;

                for (let i = 0; i < count; i++) {
                    total += Math.floor(Math.random() * faces) + 1;
                }
            }
            
            return [{ amount: Math.max(0, total), type: damageType }];
        }

        function formatDamageList(dl) {
            return dl.map(x => `${x.amount} ${x.type}`).join(' + ') || '0';
        }

        function clamp(n, min, max) {
            return Math.max(min, Math.min(max, n));
        }

        // ç®€åŒ–çš„ CR è‡ªåŠ¨è°ƒæ•´å ä½ï¼ˆTODOï¼šæ›¿æ¢ä¸ºæ­£å¼è§„åˆ™è¡¨ï¼‰
        function adjustMonsterToCR(mon, targetCR) {
            const out = deepClone(mon);
            const cr = Number(targetCR) || mon.cr || 1;
            // éæ­£å¼ï¼šä»¥ CR çº¿æ€§è¿‘ä¼¼ï¼Œä½œä¸ºå ä½
            const scale = (cr) / (mon.cr || 1);
            out.cr = cr;
            out.ac = Math.round(clamp((mon.ac || 12) + (scale - 1) * 2, 8, 25));
            const baseHP = mon.hp?.average ?? mon.hp ?? 10;
            out.hp = {
                average: Math.round(clamp(baseHP * scale, 5, 600)),
                roll: mon.hp?.roll || ''
            };
            // è°ƒæ•´åŠ¨ä½œæ”»å‡»åŠ å€¼ä¸ä¼¤å®³éª°ï¼ˆä»…æŠŠä¼¤å®³/è½®æå‡ä¸ºè¿‘ä¼¼ï¼›éª°å­æ™ºèƒ½åç®— TODOï¼‰
            (out.actions || []).forEach(a => {
                if (a.type === 'attack') {
                    a.attackBonus = Math.round((a.attackBonus || 3) + (scale - 1) * 2);
                    // ç²—ç•¥ä¼¤å®³ä¸Šè°ƒï¼šé¢å¤– +Xd6
                    a.damageDice = a.damageDice ? `${a.damageDice}+${Math.max(1, Math.round(scale))}d6` : `${Math.max(1, Math.round(1*scale))}d6`;
                }
                if (a.type === 'save') {
                    a.saveDC = Math.round((a.saveDC || 12) + (scale - 1) * 2);
                    a.damageDice = a.damageDice ? `${a.damageDice}+${Math.max(1, Math.round(scale))}d6` : `${Math.max(2, Math.round(2*scale))}d6`;
                }
            });
            return out;
        }

        createApp({
            setup() {
                const route = ref('battle'); // é»˜è®¤è·³åˆ°æˆ˜æ–—é¡µä¾¿äºçœ‹å¸ƒå±€
                const monsters = ref([]);
                const abilities = ref([]);
                const pcs = ref([]);
                const actions = ref([]);
                const monsterFilters = reactive({
                    keyword: '',
                    cr: '',
                    types: []
                });
                const monsterTypes = ref(['aberration', 'beast', 'celestial', 'construct', 'dragon', 'elemental', 'fey', 'fiend', 'giant', 'humanoid', 'monstrosity', 'ooze', 'plant', 'undead', 'goblinoid']);
                const damageTypes = ref(['é’å‡»', 'ç©¿åˆº', 'æ–©å‡»', 'ç«ç„°', 'å¯’å†·', 'åŠ›åœº', 'æ¯’ç´ ', 'é…¸æ€§', 'é—ªç”µ', 'å¿ƒçµ', 'å…‰è€€', 'æ­»çµ', 'é›·é¸£']);
                const monsterTypeTranslations = {
                    'aberration': 'å¼‚æ€ª',
                    'beast': 'é‡å…½',
                    'celestial': 'å¤©ç•Œç”Ÿç‰©',
                    'construct': 'æ„è£…ä½“',
                    'dragon': 'é¾™',
                    'elemental': 'å…ƒç´ ',
                    'fey': 'ç²¾ç±»',
                    'fiend': 'é‚ªé­”',
                    'giant': 'å·¨äºº',
                    'humanoid': 'äººå½¢ç”Ÿç‰©',
                    'monstrosity': 'æ€ªå…½',
                    'ooze': 'æ³¥æ€ª',
                    'plant': 'æ¤ç‰©',
                    'undead': 'ä¸æ­»ç”Ÿç‰©',
                    'goblinoid': 'ç±»å“¥å¸ƒæ—'
                };
                const translateType = (t) => monsterTypeTranslations[t] || t;
                const crOptions = ref(['0', '0.125', '0.25', '0.5', ...Array.from({
                    length: 30
                }, (_, i) => (i + 1).toString())]);
                const battle = reactive({
                    participants: [],
                    currentIndex: 0,
                    round: 1,
                    dragIndex: null,
                });
                const ui = reactive({
                    monsterEditor: {
                        open: false,
                        mode: 'edit', // 'view' or 'edit'
                    },
                    abilityPool: {
                        open: false,
                        keyword: '',
                        nested: false
                    },
                    actionPool: {
                        open: false,
                        keyword: '',
                        nested: false
                    },
                    actionsViewer: { 
                        open: false, 
                        draft: null, 
                        title: '' 
                    },
                    saveCheck: {
                      open: false,
                      targetName: '',
                      dc: 0,
                      ability: '',
                      callback: null
                    },
                    abilityEditor: {
                        open: false
                    },
                    pcEditor: {
                        open: false
                    },
                    activeEditor: null, // 'monster' or 'pc'
                    actionEditor: {
                        open: false
                    },
                    statusPicker: {
                        open: false,
                        targetUid: null,
                        selectedName: 'æŸç¼š Restrained',
                        rounds: 3,
                        icon: 'â›“ï¸'
                    },
                    addParticipants: {
                        open: false,
                        keywordM: '',
                        keywordP: ''
                    },
                    selectedAction: null,
                    rollMode: 'normal',
                    autoApplyDamage: true,
                    selectedTargets: [],
                    log: '',
                });
                const hpDelta = ref(5);
                const currentActor = computed(() => battle.participants[battle.currentIndex] || null);
                // æ€ªç‰©ç¼–è¾‘å™¨è‰ç¨¿
                const emptyMonster = () => ({
                    name: '',
                    cr: 1,
                    type: [],
                    ac: 12,
                    hp: {
                        average: 10,
                        roll: '1d8+2'
                    },
                    speed: {
                        walk: 30
                    },
                    abilities: {
                        str: 10,
                        dex: 10,
                        con: 10,
                        int: 10,
                        wis: 10,
                        cha: 10
                    },
                    resistances: {
                        damage: [],
                        conditions: []
                    },
                    vulnerabilities: {
                        damage: [],
                        conditions: []
                    },
                    immunities: {
                        damage: [],
                        conditions: []
                    },
                    actions: []
                });
                const uiState = reactive({
                    monsterDraft: emptyMonster(),
                    targetCR: null,
                    abilityDraft: {
                        name: '',
                        description: ''
                    },
                    pcDraft: {
                        name: '',
                        ac: 14,
                        hpMax: 20,
                        hpCurrent: 20,
                        abilities: {
                            str: 10,
                            dex: 10,
                            con: 10,
                            int: 10,
                            wis: 10,
                            cha: 10
                        },
                        actions: []
                    },
                    actionDraft: { name: '', type: 'attack', damageType: 'æ–©å‡»', recharge: 0 },
                });
                const monsterTypesStr = computed({
                    get() {
                        return (uiState.monsterDraft.type || []).join(', ');
                    },
                    set(v) {
                        uiState.monsterDraft.type = (v || '').split(',').map(s => s.trim()).filter(Boolean);
                    }
                });
                // å°†é€—å·åˆ†éš”çš„å­—ç¬¦ä¸²è§†å›¾å­—æ®µä¸æ•°ç»„äº’è½¬
                function bindListStrings(draft) {
                    draft.resistances.damageStr = (draft.resistances.damage || []).join(', ');
                    draft.vulnerabilities.damageStr = (draft.vulnerabilities.damage || []).join(', ');
                    draft.immunities.damageStr = (draft.immunities.damage || []).join(', ');
                    draft.immunities.conditionsStr = (draft.immunities.conditions || []).join(', ');
                }

                function unbindListStrings(draft) {
                    draft.resistances.damage = (draft.resistances.damageStr || '').split(',').map(s => s.trim()).filter(Boolean);
                    draft.vulnerabilities.damage = (draft.vulnerabilities.damageStr || '').split(',').map(s => s.trim()).filter(Boolean);
                    draft.immunities.damage = (draft.immunities.damageStr || '').split(',').map(s => s.trim()).filter(Boolean);
                    draft.immunities.conditions = (draft.immunities.conditionsStr || '').split(',').map(s => s.trim()).filter(Boolean);
                    delete draft.resistances.damageStr;
                    delete draft.vulnerabilities.damageStr;
                    delete draft.immunities.damageStr;
                    delete draft.immunities.conditionsStr;
                }
                const filteredMonsters = computed(() => {
                    return monsters.value.filter(m => !monsterFilters.keyword || m.name.includes(monsterFilters.keyword)).filter(m => !monsterFilters.cr || String(m.cr) === monsterFilters.cr).filter(m => monsterFilters.types.length === 0 || (m.type || []).some(t => monsterFilters.types.includes(t)));
                });

                function toggleTypeFilter(t) {
                    const idx = monsterFilters.types.indexOf(t);
                    if (idx >= 0) monsterFilters.types.splice(idx, 1);
                    else monsterFilters.types.push(t);
                }
                const filteredAbilities = computed(() => {
                    return abilities.value.filter(a => !ui.abilityPool.keyword || a.name.includes(ui.abilityPool.keyword));
                });
                const filteredActions = computed(() => {
                    return actions.value.filter(a => !ui.actionPool.keyword || a.name.includes(ui.actionPool.keyword));
                });
                // åŠ è½½æ•°æ®
                async function loadAll() {
                    monsters.value = await db.monsters.toArray();
                    abilities.value = await db.abilities.toArray();
                    pcs.value = await db.pcs.toArray();
                    actions.value = await db.actions.toArray();
                }
                async function seedDemo() {
                    await seedIfEmpty();
                    await loadAll();
                    toast('å·²è½½å…¥æ¼”ç¤ºæ•°æ®');
                }
                // æ€ªç‰© CRUD
                function openMonsterEditor(m = null) {
                    const draft = deepClone(m || emptyMonster());
                    draft.isCustom = !!draft.isCustom;
                    uiState.monsterDraft = draft;
                    uiState.targetCR = draft.cr;
                    bindListStrings(uiState.monsterDraft);
                    ui.monsterEditor.mode = m ? 'view' : 'edit'; // æ–°å»ºæ—¶é»˜è®¤ä¸ºç¼–è¾‘ï¼ŒæŸ¥çœ‹æ—¶é»˜è®¤ä¸ºè§†å›¾
                    ui.activeEditor = 'monster';
                    ui.monsterEditor.open = true;
                }
                async function saveMonsterAsCustom() {
                    const draft = deepClone(uiState.monsterDraft);
                    unbindListStrings(draft);
                    draft.isCustom = true;
                    draft.id = undefined; // Ensure it's a new entry
                    if (draft.name) {
                        await db.monsters.add(draft);
                        await loadAll();
                        ui.monsterEditor.open = false;
                        toast('å·²ä¿å­˜ä¸ºè‡ªå®šä¹‰æ€ªç‰©');
                    } else {
                        toast('åç§°ä¸èƒ½ä¸ºç©º');
                    }
                }
                async function duplicateMonster(m) {
                    const copy = deepClone(m);
                    copy.id = undefined;
                    copy.name = m.name + 'ï¼ˆå‰¯æœ¬ï¼‰';
                    copy.isCustom = true;
                    await db.monsters.add(copy);
                    await loadAll();
                    toast('å·²å¤åˆ¶');
                }
                async function deleteMonster(id) {
                    if (!confirm('ç¡®è®¤åˆ é™¤è¯¥æ€ªç‰©ï¼Ÿ')) return;
                    await db.monsters.delete(id);
                    await loadAll();
                    toast('å·²åˆ é™¤');
                }
                // èƒ½åŠ›æ± 
                function openAbilityPool() {
                    ui.abilityPool.nested = ui.monsterEditor.open || ui.pcEditor.open || ui.actionsViewer.open;
                    ui.abilityPool.open = true;
                }

                function openAbilityEditor(ab = null) {
                    uiState.abilityDraft = ab ? deepClone(ab) : {
                        name: '',
                        description: ''
                    };
                    ui.abilityEditor.open = true;
                }

                function openActionsViewer(draft, type) {
                    ui.actionsViewer.draft = draft;
                    ui.actionsViewer.title = `ç®¡ç† ${draft.name} çš„åŠ¨ä½œ`;
                    ui.actionsViewer.open = true;
                }
                async function saveAbility() {
                    const ab = deepClone(uiState.abilityDraft);
                    if (!ab.name) return toast('è¯·å¡«å†™åç§°');
                    if (ab.id) await db.abilities.put(ab);
                    else await db.abilities.add(ab);
                    await loadAll();
                    ui.abilityEditor.open = false;
                    toast('èƒ½åŠ›å·²ä¿å­˜');
                }
                async function deleteAbility(id) {
                    if (!confirm('ç¡®è®¤åˆ é™¤è¯¥èƒ½åŠ›ï¼Ÿ')) return;
                    await db.abilities.delete(id);
                    abilities.value = await db.abilities.toArray();
                    toast('å·²åˆ é™¤');
                }

                function attachAbilityToDraft(ab) {
                    uiState.monsterDraft.actions = uiState.monsterDraft.actions || [];
                    uiState.monsterDraft.actions.push({
                        id: crypto.randomUUID(),
                        name: ab.name,
                        type: 'utility',
                        note: ab.description
                    });
                    toast('å·²æ·»åŠ åˆ°å½“å‰æ€ªç‰©åŠ¨ä½œ/èƒ½åŠ›ä¸­');
                }

                function openActionPool() {
                    ui.actionPool.nested = ui.pcEditor.open || ui.monsterEditor.open || ui.actionsViewer.open;
                    ui.actionPool.open = true;
                }

                function attachActionToDraft(action) {
                    const draft = ui.activeEditor === 'pc' ? uiState.pcDraft : uiState.monsterDraft;
                    if (!draft) return;
                    draft.actions = draft.actions || [];
                    const actionCopy = deepClone(action);
                    delete actionCopy.id;
                    draft.actions.push(actionCopy);
                    toast(`å·²å°†åŠ¨ä½œæ·»åŠ åˆ°å½“å‰${ui.activeEditor === 'pc' ? 'PC' : 'æ€ªç‰©'}`);
                }

                // Action CRUD
                function openActionEditor(action = null) {
                    uiState.actionDraft = action ? deepClone(action) : {
                        name: 'æ–°åŠ¨ä½œ',
                        type: 'attack',
                        attackBonus: 4,
                        damageDice: '1d6+2',
                        damageType: 'æ–©å‡»',
                        recharge: 0,
                        saveAbility: 'dex',
                        saveDC: 13,
                        onSuccess: 'half',
                        onHitStatus: '',
                        onHitStatusRounds: 1,
                        onHitSaveAbility: 'dex',
                        onHitSaveDC: 13,
                    };
                    ui.actionEditor.open = true;
                }
                async function saveAction() {
                    const draft = deepClone(uiState.actionDraft);
                    if (!draft.name) return toast('è¯·å¡«å†™åç§°');
                    if (draft.id) await db.actions.put(draft);
                    else await db.actions.add(draft);
                    await loadAll();
                    ui.actionEditor.open = false;
                    toast('åŠ¨ä½œå·²ä¿å­˜');
                }
                async function deleteAction(id) {
                    if (!confirm('ç¡®è®¤åˆ é™¤è¯¥åŠ¨ä½œï¼Ÿ')) return;
                    await db.actions.delete(id);
                    actions.value = await db.actions.toArray();
                    toast('å·²åˆ é™¤');
                }

                // PC CRUD
                function openPCEditor(pc = null) {
                    const draft = pc ? deepClone(pc) : {
                        name: '',
                        ac: 14,
                        hpMax: 20,
                        hpCurrent: 20,
                        abilities: { str: 10, dex: 10, con: 10, int: 10, wis: 10, cha: 10 },
                        actions: [],
                        features: ''
                    };
                    if (!draft.actions) draft.actions = [];
                    if (!draft.features) draft.features = '';
                    uiState.pcDraft = draft;
                    ui.activeEditor = 'pc';
                    ui.pcEditor.open = true;
                }
async function savePC() {
    const draft = deepClone(uiState.pcDraft);
    if (!draft.name) {
        toast('è¯·å¡«å†™åç§°');
        return;
    }
    if (draft.id) {
        await db.pcs.put(draft);
    } else {
        draft.id = undefined;
        await db.pcs.add(draft);
    }
    await loadAll();
    ui.pcEditor.open = false;
    toast('PCå·²ä¿å­˜');
}
                async function deletePC(id) {
                    if (!confirm('ç¡®è®¤åˆ é™¤è¯¥PCï¼Ÿ')) return;
                    await db.pcs.delete(id);
                    pcs.value = await db.pcs.toArray();
                    toast('å·²åˆ é™¤');
                }
                // CR è°ƒæ•´
                function autoAdjustCR() {
                    const adjusted = adjustMonsterToCR(unbindProxy(uiState.monsterDraft), uiState.targetCR);
                    // æ³¨æ„ï¼šæˆ‘ä»¬ä»åœ¨ç¼–è¾‘å™¨ä¸­å±•ç¤ºï¼Œå¯è®©DMäºŒæ¬¡ç¡®è®¤åä¿å­˜ä¸ºè‡ªå®šä¹‰æ€ªç‰©
                    uiState.monsterDraft = adjusted;
                    bindListStrings(uiState.monsterDraft);
                    toast('å·²æŒ‰å ä½è§„åˆ™è°ƒæ•´ï¼ˆTODOï¼šæ›¿æ¢ä¸ºæ­£å¼æ™ºèƒ½è§„åˆ™è¡¨ï¼‰');
                }
                // å‚ä¸æˆ˜æ–—
                function standardizeToParticipant(x) {
                    const uid = crypto.randomUUID();
                    return {
                        uid,
                        baseId: x.id || null,
                        name: x.name,
                        type: x.hpMax ? 'pc' : 'monster',
                        groupName: x.name, // åŒåè‡ªåŠ¨åˆ†ç»„
                        avatar: x.type?.includes?.('dragon') ? 'ğŸ²' : (x.hpMax ? 'ğŸ§' : 'ğŸ‘¾'),
                        ac: x.ac || 12,
                        hpMax: x.hpMax || x.hp?.average || 10,
                        hpCurrent: x.hpCurrent || x.hp?.average || 10,
                        abilities: x.abilities || {
                            str: 10,
                            dex: 10,
                            con: 10,
                            int: 10,
                            wis: 10,
                            cha: 10
                        },
                        actions: deepClone(x.actions || []).map(a => ({...a, cooldown: 0})),
                        statuses: [],
                        initiative: null,
                    };
                }

                function addToBattleFromEditor(entity, type) {
                    const p = standardizeToParticipant(entity);
                    battle.participants.push(p);
                    if (type === 'monster') {
                        ui.monsterEditor.open = false;
                    } else if (type === 'pc') {
                        ui.pcEditor.open = false;
                    }
                    route.value = 'battle';
                    toast(`${p.name} å·²åŠ å…¥æˆ˜æ–—`);
                }

                function addToBattleFromMonster(m) {
                    battle.participants.push(standardizeToParticipant(m));
                    route.value = 'battle';
                    toast('å·²åŠ å…¥æˆ˜æ–—');
                }

                function addToBattleFromPC(pc) {
                    battle.participants.push(standardizeToParticipant(pc));
                    route.value = 'battle';
                    toast('å·²åŠ å…¥æˆ˜æ–—');
                }
                // æ·»åŠ å‚æˆ˜å•ä½ modal
                function promptAddParticipants() {
                    ui.addParticipants.open = true;
                }

                function addParticipantsFromMonster(m, count = 1) {
                    for (let i = 0; i < count; i++) {
                        const p = standardizeToParticipant(m);
                        if (count > 1) p.name = `${m.name} #${i+1}`;
                        battle.participants.push(p);
                    }
                    toast('æ€ªç‰©å·²åŠ å…¥');
                }

                function addParticipantsFromPC(pc) {
                    battle.participants.push(standardizeToParticipant(pc));
                    toast('PCå·²åŠ å…¥');
                }
                // å…ˆæ”»ä¸å›åˆ
function rollInitiative() {
    for (const p of battle.participants) {
        const dexModifier = abilityMod(p.abilities.dex || 10);
        const d20Roll = Math.floor(Math.random() * 20) + 1;
        p.initiativeRoll = d20Roll; // Store the raw d20 roll
        p.initiativeModifier = dexModifier; // Store the modifier
        p.initiative = d20Roll + dexModifier; // Keep the total for sorting
    }

    battle.participants.sort((a, b) => {
        const aNatural20 = a.initiativeRoll === 20;
        const bNatural20 = b.initiativeRoll === 20;

        if (aNatural20 && !bNatural20) {
            return -1; // a goes first
        } else if (!aNatural20 && bNatural20) {
            return 1; // b goes first
        } else if (aNatural20 && bNatural20) {
            // Both rolled 20, sort by modifier
            return (b.initiativeModifier || 0) - (a.initiativeModifier || 0);
        } else {
            // Neither rolled 20, sort by total initiative
            return (b.initiative || 0) - (a.initiative || 0);
        }
    });

    battle.currentIndex = 0;
    battle.round = 1;
    toast('å·²æ·å…ˆæ”»å¹¶æ’åº');
}

                function setCurrentActor(uid) {
                    const idx = battle.participants.findIndex(p => p.uid === uid);
                    if (idx >= 0) battle.currentIndex = idx;
                }

                function nextTurn() {
                        if (!battle.participants.length) return;

                        const activeParticipant = currentActor.value;
                        let participantWasRemoved = false;

                        // æ£€æŸ¥å½“å‰è¡ŒåŠ¨è€…æ˜¯å¦æ˜¯å·²é˜µäº¡çš„æ€ªç‰©
                        if (activeParticipant && activeParticipant.hpCurrent <= 0 && activeParticipant.type === 'monster') {
                            const deadMonsterName = activeParticipant.name;
                            // ç›´æ¥ä½¿ç”¨ removeParticipant å‡½æ•°ï¼Œå®ƒä¼šå¤„ç†ç´¢å¼•
                            removeParticipant(activeParticipant.uid);
                            toast(`æ€ªç‰©ã€${deadMonsterName}ã€‘å·²åœ¨å›åˆç»“æŸåç§»é™¤ã€‚`);
                            participantWasRemoved = true;
                            // æ³¨æ„ï¼šæ­¤æ—¶ currentIndex ä¸éœ€è¦æ”¹å˜ï¼Œå› ä¸ºä¸‹ä¸€ä¸ªå•ä½å·²ç»ç§»åŠ¨åˆ°äº†å½“å‰ç´¢å¼•
                        }

                        // å¦‚æœæ²¡æœ‰ç§»é™¤å•ä½ï¼Œæ­£å¸¸æ¨è¿›å›åˆ
                        if (!participantWasRemoved) {
                            battle.currentIndex++;
                        }

                        // æ£€æŸ¥æ˜¯å¦éœ€è¦è½®è½¬åˆ°å›åˆå¼€å§‹
                        if (battle.currentIndex >= battle.participants.length) {
                            battle.currentIndex = 0; // è½®è½¬
                            battle.round++;
                        }

                        // ä¸ºæ–°å›åˆçš„è¡ŒåŠ¨è€…å¤„ç†çŠ¶æ€å’Œå†·å´
                        if (currentActor.value) {
                            decrementParticipantStatuses(currentActor.value);
                            decrementActionCooldowns(currentActor.value);
                        }
                    }
                function prevTurn() {
                    if (!battle.participants.length) return;
                    battle.currentIndex--;
                    if (battle.currentIndex < 0) {
                        battle.currentIndex = battle.participants.length - 1;
                        battle.round = Math.max(1, battle.round - 1);
                    }
                    // å›åˆå¼€å§‹ï¼šå¤„ç†å½“å‰è¡ŒåŠ¨è€…çš„çŠ¶æ€ -1 (å¦‚æœå›é€€åˆ°ä¸Šä¸€ä¸ªå›åˆï¼ŒçŠ¶æ€ä¸åº”è¯¥å‡å°‘ï¼Œæ‰€ä»¥è¿™é‡Œä¸è°ƒç”¨)
                    // å¦‚æœéœ€è¦å›é€€çŠ¶æ€ï¼Œåˆ™éœ€è¦æ›´å¤æ‚çš„é€»è¾‘ï¼Œç›®å‰åªå¤„ç†å‰è¿›
                }

                function decrementParticipantStatuses(participant) {
                    const remain = [];
                    for (const s of participant.statuses) {
                        const ns = { ...s,
                            rounds: s.rounds - 1
                        };
                        if (ns.rounds > 0) remain.push(ns);
                    }
                    participant.statuses = remain;
                }

                function decrementActionCooldowns(participant) {
                    if (!participant.actions) return;
                    participant.actions.forEach(a => {
                        if (a.cooldown > 0) {
                            a.cooldown--;
                        }
                    });
                }

                function removeParticipant(uid) {
                    const i = battle.participants.findIndex(p => p.uid === uid);
                    if (i >= 0) {
                        battle.participants.splice(i, 1);
                        if (battle.currentIndex >= battle.participants.length) battle.currentIndex = 0;
                    }
                }
                // å…ˆæ”»æ¡æ‹–æ‹½
                function onDragStart(idx) {
                    battle.dragIndex = idx;
                }

                function onDrop(idx) {
                    const from = battle.dragIndex;
                    if (from == null) return;
                    const item = battle.participants.splice(from, 1)[0];
                    battle.participants.splice(idx, 0, item);
                    battle.dragIndex = null;
                }
                // HP ä¿®æ”¹å™¨
                function applyHPDelta(p, delta) {
                    delta = Number(delta) || 0;
                    if (delta === 0) return;
                    p.hpCurrent = clamp(p.hpCurrent + delta, 0, p.hpMax);
                    // Mark monster as defeated if HP drops to 0 or below
                    if (p.hpCurrent <= 0 && p.type === 'monster') {
                        p.isDefeated = true;
                        toast(`æ€ªç‰©ã€${p.name}ã€‘è¡€é‡å½’é›¶ï¼Œå°†åœ¨å›åˆç»“æŸåç§»é™¤ã€‚`);
                    }
                }
                // çŠ¶æ€
                const statusCatalog = ref([{
                    name: 'å€’åœ° Prone',
                    icon: 'ğŸ›Œ'
                }, {
                    name: 'æŸç¼š Restrained',
                    icon: 'â›“ï¸'
                }, {
                    name: 'è‡´ç›² Blinded',
                    icon: 'ğŸ•¶ï¸'
                }, {
                    name: 'ä¸­æ¯’ Poisoned',
                    icon: 'â˜ ï¸'
                }, {
                    name: 'é­…æƒ‘ Charmed',
                    icon: 'ğŸ’'
                }, {
                    name: 'ææ…Œ Frightened',
                    icon: 'ğŸ˜±'
                }, ]);

                function openStatusPicker(target) {
                    ui.statusPicker.open = true;
                    ui.statusPicker.targetUid = target.uid;
                    // Initialize selectedName and icon when opening the picker
                    if (statusCatalog.value.length > 0) {
                        ui.statusPicker.selectedName = statusCatalog.value[0].name;
                        ui.statusPicker.icon = statusCatalog.value[0].icon;
                    }
                }

                // Watch for changes in selectedName to update the icon
                watch(() => ui.statusPicker.selectedName, (newName) => {
                    const selectedStatus = statusCatalog.value.find(s => s.name === newName);
                    if (selectedStatus) {
                        ui.statusPicker.icon = selectedStatus.icon;
                    }
                });

                function applyStatus() {
                    const t = battle.participants.find(p => p.uid === ui.statusPicker.targetUid);
                    if (!t) return;
                    t.statuses.push({
                        id: crypto.randomUUID(),
                        name: ui.statusPicker.selectedName,
                        icon: ui.statusPicker.icon || 'â³',
                        rounds: ui.statusPicker.rounds || 1,
                    });
                    ui.statusPicker.open = false; // Auto-close
                }

                function removeStatus(target, statusId) {
                    target.statuses = target.statuses.filter(s => s.id !== statusId);
                }
                // ç›®æ ‡é€‰æ‹©
                const groupedParticipants = computed(() => {
                    const groups = {};
                    for (const p of battle.participants) {
                        const g = p.groupName || p.name;
                        if (!groups[g]) groups[g] = [];
                        groups[g].push(p);
                    }
                    return Object.keys(groups).sort().map(k => ({
                        groupName: k,
                        members: groups[k]
                    }));
                });

                function toggleTarget(uid) {
                    const i = ui.selectedTargets.indexOf(uid);
                    if (i >= 0) ui.selectedTargets.splice(i, 1);
                    else ui.selectedTargets.push(uid);
                }

                function toggleSelectGroup(g) {
                    const ids = g.members.map(m => m.uid);
                    const allIn = ids.every(id => ui.selectedTargets.includes(id));
                    if (allIn) {
                        ui.selectedTargets = ui.selectedTargets.filter(id => !ids.includes(id));
                    } else { // åˆå¹¶å»é‡
                        const set = new Set(ui.selectedTargets.concat(ids));
                        ui.selectedTargets = Array.from(set);
                    }
                }

                function selectNone() {
                    ui.selectedTargets = [];
                }
                const promptSaveCheck = (target, action, onSaveFail) => {
                  ui.saveCheck.targetName = target.name;
                  ui.saveCheck.dc = action.onHitSaveDC;
                  ui.saveCheck.ability = action.onHitSaveAbility;
                  ui.saveCheck.callback = (saveSucceeded) => {
                    if (!saveSucceeded) {
                      onSaveFail(); // åªæœ‰å½“è±å…å¤±è´¥æ—¶ï¼Œæ‰æ‰§è¡Œä¼ å…¥çš„å›è°ƒ
                    }
                    ui.log += `${target.name} çš„ ${action.onHitSaveAbility.toUpperCase()} è±å…æ£€å®š (DC ${action.onHitSaveDC}) ${saveSucceeded ? 'æˆåŠŸ' : 'å¤±è´¥'}.\n`;
                  };
                  ui.saveCheck.open = true;
                };
                // åŠ¨ä½œä¸è‡ªåŠ¨åŒ–æ”»å‡»æµç¨‹
                function selectAction(a) {
                    ui.selectedAction = deepClone(a);
                    ui.log = 'å·²é€‰æ‹©åŠ¨ä½œï¼š' + a.name + '\n';
                }

                function runAction() {
                    const actor = currentActor.value;
                    const action = ui.selectedAction;
                    if (!actor || !action) return;
                    const targets = battle.participants.filter(p => ui.selectedTargets.includes(p.uid));
                    if (!targets.length) {
                        toast('è¯·å…ˆåœ¨å³ä¾§é€‰æ‹©ç›®æ ‡');
                        return;
                    }
                    let log = `ã€${actor.name}ã€‘ä½¿ç”¨ã€Œ${action.name}ã€å¯¹ ${targets.length} ä¸ªç›®æ ‡ï¼š\n`;
                    if (action.type === 'attack') {
                        for (const t of targets) {
                            const d20 = rollD20(ui.rollMode);
                            const toHit = d20.value + (action.attackBonus || 0);
                            const hit = (d20.value === 20) || (toHit >= t.ac);
                            log += `- ç›®æ ‡ã€${t.name}ã€‘ -> d20(${d20.raw.join(',')}) + ${action.attackBonus||0} = ${toHit} vs AC ${t.ac} => ${d20.value===20?'é‡å‡»':(hit?'å‘½ä¸­':'æœªå‘½ä¸­')}\n`;
                            if (hit) {
                                const dmgList = rollDamage(action.damageDice, d20.value === 20, action.damageType);
                                log += ` ä¼¤å®³ï¼š${formatDamageList(dmgList)}\n`;
                                if (ui.autoApplyDamage) {
                                    const total = dmgList.reduce((s, x) => s + x.amount, 0);
                                    t.hpCurrent = clamp(t.hpCurrent - total, 0, t.hpMax);
                                    log += ` å·²è‡ªåŠ¨æ‰£è¡€ï¼š-${dmgList.reduce((s,x)=>s+x.amount,0)}ï¼Œå‰©ä½™HP ${t.hpCurrent}\n`;
                                } else {
                                    log += ` ï¼ˆæœªè‡ªåŠ¨æ‰£è¡€ï¼‰\n`;
                                }
                                // é™„åŠ çŠ¶æ€
                                if (action.onHitStatus) {
                                  const applyStatus = () => {
                                    const existingStatus = t.statuses.find(s => s.name === action.onHitStatus);
                                    if (!existingStatus) {
                                      t.statuses.push({ name: action.onHitStatus, duration: -1 });
                                      log(`${t.name} è·å¾—äº†çŠ¶æ€: ${action.onHitStatus}.`);
                                    }
                                  };

                                  if (action.onHitSaveAbility && action.onHitSaveDC) {
                                    // éœ€è¦è±å…æ£€å®š
                                    promptSaveCheck(t, action, applyStatus);
                                  } else {
                                    // æ— éœ€è±å…ï¼Œç›´æ¥é™„åŠ 
                                    applyStatus();
                                  }
                                }
                            }
                        }
                        ui.log = log;
                    } else if (action.type === 'save') {
                        // å¼¹çª—æ”¹ä¸ºæç¤ºï¼šè¿™é‡Œç›´æ¥ä½¿ç”¨æŒ‰é’®è¾“å…¥æˆåŠŸ/å¤±è´¥çš„äº¤äº’ TODO
                        log += `è±å…æ£€å®šï¼šDC ${action.saveDC}ï¼Œå±æ€§ ${action.saveAbility?.toUpperCase?.()}\n`;
                        log += `è¯·æ ¹æ®çº¿ä¸‹ç©å®¶æ·éª°ï¼Œé€ä¸ªç‚¹é€‰æˆåŠŸ/å¤±è´¥ï¼ˆå ä½äº¤äº’ï¼šé»˜è®¤å‡å¤±è´¥ï¼‰\n`;
                        // å ä½ï¼šé»˜è®¤å¤±è´¥ï¼ˆå…¨ä¼¤ï¼‰
                        for (const t of targets) {
                            const success = false; // TODO: å¼¹çª—ç¡®è®¤æˆåŠŸ/å¤±è´¥
                            const dmgList = rollDamage(action.damageDice, false, action.damageType);
                            const total = dmgList.reduce((s, x) => s + x.amount, 0);
                            const final = success ? (action.onSuccess === 'half' ? Math.floor(total / 2) : 0) : total;
                            if (ui.autoApplyDamage) {
                                t.hpCurrent = clamp(t.hpCurrent - final, 0, t.hpMax);
                            }
                            log += `- ç›®æ ‡ã€${t.name}ã€‘ -> ${success?'æˆåŠŸ':'å¤±è´¥'}ï¼Œä¼¤å®³ ${final}ï¼ˆ${formatDamageList(dmgList)}${success?'ï¼ŒæˆåŠŸè§„åˆ™ï¼š'+(action.onSuccess==='half'?'åŠä¼¤':'å…ç–«'):''}ï¼‰; HP=${t.hpCurrent}\n`;
                        }
                        ui.log = log + 'ï¼ˆTODOï¼šåœ¨æ‰§è¡Œå‰å¼¹å‡ºåˆ†ç›®æ ‡ç¡®è®¤çš„æˆåŠŸ/å¤±è´¥æŒ‰é’®ï¼‰';
                    } else {
                        ui.log = 'è¯¥åŠ¨ä½œä¸æ”¯æŒè‡ªåŠ¨ç»“ç®—ï¼ˆutilityï¼‰ã€‚';
                    }

                    // Cooldown
                    if (action.recharge > 0) {
                        const actorAction = actor.actions.find(a => a.name === action.name); // Find by name, might need better ID later
                        if (actorAction) {
                            actorAction.cooldown = action.recharge;
                            log += `\nã€Œ${action.name}ã€è¿›å…¥å†·å´ï¼Œ${action.recharge}å›åˆåå¯ç”¨ã€‚`;
                            ui.log = log;
                        }
                    }
                }
                // å¯¼å‡ºå¯¼å…¥
                async function exportAll() {
                    const data = {
                        meta: {
                            app: 'dnd-assist-v2',
                            exportedAt: new Date().toISOString(),
                            version: 1
                        },
                        monsters: await db.monsters.toArray(),
                        abilities: await db.abilities.toArray(),
                        pcs: await db.pcs.toArray(),
                    };
                    const blob = new Blob([JSON.stringify(data, null, 2)], {
                        type: 'application/json'
                    });
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    a.download = `dnd-local-v2-export-${Date.now()}.json`;
                    a.click();
                    URL.revokeObjectURL(a.href);
                }
                async function importAll(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    const text = await file.text();
                    try {
                        const data = JSON.parse(text);
                        if (!data.monsters || !data.abilities || !data.pcs) throw new Error('æ ¼å¼ä¸å®Œæ•´');
                        if (!confirm('å¯¼å…¥å°†è¦†ç›–ç°æœ‰åŒåæ•°æ®ï¼ˆæŒ‰ç®€å•è¿½åŠ ï¼‰ã€‚ç»§ç»­å—ï¼Ÿ')) return;
                        await db.transaction('rw', db.monsters, db.abilities, db.pcs, async () => {
                            await db.monsters.clear();
                            await db.abilities.clear();
                            await db.pcs.clear();
                            await db.monsters.bulkAdd(data.monsters);
                            await db.abilities.bulkAdd(data.abilities);
                            await db.pcs.bulkAdd(data.pcs);
                        });
                        await loadAll();
                        toast('å¯¼å…¥æˆåŠŸ');
                    } catch (err) {
                        alert('å¯¼å…¥å¤±è´¥ï¼š' + err.message);
                    } finally {
                        e.target.value = '';
                    }
                }
                // å°æç¤º
                function toast(msg) {
                    console.log('[toast]', msg);
                }
                // æ‚é¡¹
                function mod(v) {
                    return abilityMod(Number(v) || 10);
                }

                function toggleTheme() { // é¢„ç•™ï¼šå½“å‰ä¸ºæš—è‰²ï¼ŒTODOï¼šåˆ‡æ¢åˆ°æµ…è‰²ä¸»é¢˜ï¼ˆæ›¿æ¢CSSå˜é‡ï¼‰
                    alert('TODOï¼šæµ…è‰²ä¸»é¢˜åˆ‡æ¢');
                }

                function unbindProxy(v) {
                    return JSON.parse(JSON.stringify(v));
                }
                // å½“å‰è¡ŒåŠ¨è€… HP è¾“å…¥æ¸…é›¶åŒæ­¥
                watch(() => battle.currentIndex, () => {
                    hpDelta.value = 5;
                });
                // é¦–æ¬¡è½½å…¥
                (async () => {
                    await seedIfEmpty();
                    await loadAll();
                })();
                return {
                    route,
                    monsters,
                    abilities,
                    pcs,
                    actions,
                    monsterFilters,
                    monsterTypes,
                    damageTypes,
                    translateType,
                    crOptions,
                    filteredMonsters,
                    toggleTypeFilter,
                    ui,
                    uiState,
                    monsterTypesStr,
                    openMonsterEditor,
                    saveMonsterAsCustom,
                    duplicateMonster,
                    deleteMonster,
                    openAbilityPool,
                    openAbilityEditor,
                    saveAbility,
                    openActionsViewer,
                    deleteAbility,
                    filteredAbilities,
                    attachAbilityToDraft,
                    filteredActions,
                    openActionPool,
                    attachActionToDraft,
                    openPCEditor,
                    savePC,
                    deletePC,
                    openActionEditor,
                    saveAction,
                    deleteAction,
                    seedDemo,
                    battle,
                    currentActor,
                    hpDelta,
                    promptAddParticipants,
                    addParticipantsFromMonster,
                    addParticipantsFromPC,
                    addToBattleFromEditor,
                    addToBattleFromMonster,
                    addToBattleFromPC,
                    rollInitiative,
                    nextTurn,
                    prevTurn,
                    setCurrentActor,
                    onDragStart,
                    onDrop,
                    removeParticipant,
                    applyHPDelta,
                    statusCatalog,
                    openStatusPicker,
                    applyStatus,
                    removeStatus,
                    groupedParticipants,
                    toggleTarget,
                    toggleSelectGroup,
                    selectNone,
                    selectAction,
                    runAction,
                    exportAll,
                    importAll,
                    mod,
                    toggleTheme,
                    autoAdjustCR,
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
